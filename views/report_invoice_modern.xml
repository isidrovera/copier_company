<?xml version="1.0" encoding="utf-8"?>
<odoo>
    
    <!-- Heredar el template principal de factura -->
    <template id="report_invoice_document_modern" inherit_id="account.report_invoice_document" name="Modern Invoice Document">
        
        <!-- Reemplazar toda la estructura dentro de external_layout -->
        <xpath expr="//t[@t-call='web.external_layout']/div[@class='row']" position="replace">
            <div class="modern-invoice-wrapper">
                
                <!-- ============================================ -->
                <!-- HEADER MODERNO CON GRADIENTE -->
                <!-- ============================================ -->
                <div class="modern-header">
                    <div class="modern-header-content">
                        <!-- Información de la Empresa -->
                        <div class="company-section">
                            <div class="company-logo" t-if="o.company_id.logo">
                                <img t-att-src="image_data_uri(o.company_id.logo)" 
                                     alt="Company Logo" 
                                     style="max-height: 70px;"/>
                            </div>
                            <div class="company-info">
                                <h1 class="company-name" t-field="o.company_id.name"/>
                                <div class="company-details">
                                    <div t-field="o.company_id.partner_id" 
                                         t-options='{"widget": "contact", "fields": ["address"], "no_marker": true}'/>
                                    <div t-if="o.company_id.vat" class="company-vat">
                                        <strong>RUC:</strong> <span t-field="o.company_id.vat"/>
                                    </div>
                                    <div t-if="o.company_id.phone" class="company-phone">
                                        <strong>Tel:</strong> <span t-field="o.company_id.phone"/>
                                    </div>
                                    <div t-if="o.company_id.email" class="company-email">
                                        <strong>Email:</strong> <span t-field="o.company_id.email"/>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Título de Factura -->
                        <div class="invoice-title-section">
                            <h2 class="invoice-type-title">
                                <span t-if="not proforma"/>
                                <span t-else="">PROFORMA</span>
                                <span t-if="o.move_type == 'out_invoice' and o.state == 'posted'">FACTURA</span>
                                <span t-elif="o.move_type == 'out_invoice' and o.state == 'draft'">BORRADOR</span>
                                <span t-elif="o.move_type == 'out_invoice' and o.state == 'cancel'">ANULADA</span>
                                <span t-elif="o.move_type == 'out_refund' and o.state == 'posted'">NOTA DE CRÉDITO</span>
                                <span t-elif="o.move_type == 'out_refund' and o.state == 'draft'">BORRADOR N/C</span>
                                <span t-elif="o.move_type == 'out_refund' and o.state == 'cancel'">N/C ANULADA</span>
                                <span t-elif="o.move_type == 'in_refund'">NOTA CRÉDITO PROVEEDOR</span>
                                <span t-elif="o.move_type == 'in_invoice'">FACTURA PROVEEDOR</span>
                            </h2>
                            <div class="invoice-number" t-if="o.name and o.name != '/'">
                                <span t-field="o.name"/>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- ============================================ -->
                <!-- GRID DE FECHAS E INFORMACIÓN -->
                <!-- ============================================ -->
                <div class="modern-dates-grid">
                    <div class="date-card" t-if="o.invoice_date">
                        <label>
                            <t t-if="o.move_type == 'out_invoice'">Fecha Factura</t>
                            <t t-elif="o.move_type == 'out_refund'">Fecha N/C</t>
                            <t t-else="">Fecha</t>
                        </label>
                        <div class="date-value" t-field="o.invoice_date"/>
                    </div>
                    
                    <div class="date-card" t-if="o.invoice_date_due and o.move_type == 'out_invoice' and o.state == 'posted'">
                        <label>Fecha Vencimiento</label>
                        <div class="date-value" t-field="o.invoice_date_due"/>
                    </div>
                    
                    <div class="date-card" t-if="o.invoice_origin">
                        <label>Origen</label>
                        <div class="date-value" t-field="o.invoice_origin"/>
                    </div>
                    
                    <div class="date-card" t-if="o.ref">
                        <label>Referencia</label>
                        <div class="date-value" t-field="o.ref"/>
                    </div>

                    <div class="date-card" t-if="o.delivery_date">
                        <label>Fecha Entrega</label>
                        <div class="date-value" t-field="o.delivery_date"/>
                    </div>

                    <div class="date-card" t-if="o.partner_id.ref">
                        <label>Código Cliente</label>
                        <div class="date-value" t-field="o.partner_id.ref"/>
                    </div>
                </div>

                <!-- ============================================ -->
                <!-- INFORMACIÓN CLIENTE Y PAGO -->
                <!-- ============================================ -->
                <div class="modern-info-grid">
                    <!-- Card Cliente -->
                    <div class="info-card">
                        <h3 class="info-card-title">Cliente</h3>
                        <div class="info-card-content">
                            <strong class="partner-name" t-field="o.partner_id.name"/>
                            <div class="partner-address" 
                                 t-field="o.partner_id" 
                                 t-options='{"widget": "contact", "fields": ["address"], "no_marker": true}'/>
                            <div t-if="o.partner_id.vat" class="partner-vat">
                                <strong>
                                    <t t-if="o.company_id.account_fiscal_country_id.vat_label" 
                                       t-out="o.company_id.account_fiscal_country_id.vat_label"/>
                                    <t t-else="">RUC/DNI</t>:
                                </strong>
                                <span t-field="o.partner_id.vat"/>
                            </div>
                            <div t-if="o.partner_id.phone" class="partner-phone">
                                <strong>Teléfono:</strong> <span t-field="o.partner_id.phone"/>
                            </div>
                        </div>
                    </div>

                    <!-- Card Dirección de Envío (si es diferente) -->
                    <div class="info-card" t-if="o.partner_shipping_id and (o.partner_shipping_id != o.partner_id)">
                        <h3 class="info-card-title">Dirección de Envío</h3>
                        <div class="info-card-content">
                            <div t-field="o.partner_shipping_id" 
                                 t-options='{"widget": "contact", "fields": ["address", "name"], "no_marker": true}'/>
                        </div>
                    </div>

                    <!-- Card Información de Pago -->
                    <div class="info-card">
                        <h3 class="info-card-title">Información de Pago</h3>
                        <div class="info-card-content">
                            <div t-if="o.invoice_payment_term_id">
                                <strong>Términos:</strong> <span t-field="o.invoice_payment_term_id.name"/>
                            </div>
                            <div t-if="o.payment_reference">
                                <strong>Referencia:</strong> <span t-field="o.payment_reference"/>
                            </div>
                            <div t-if="o.partner_bank_id">
                                <strong>Banco:</strong> <span t-field="o.partner_bank_id.bank_id.name"/>
                            </div>
                            <div t-if="o.partner_bank_id">
                                <strong>Cuenta:</strong> <span t-field="o.partner_bank_id.acc_number"/>
                            </div>
                            <div t-if="o.invoice_incoterm_id">
                                <strong>Incoterm:</strong> 
                                <span t-field="o.invoice_incoterm_id.code"/>
                                <span t-if="o.incoterm_location"> - <span t-field="o.incoterm_location"/></span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- OE Structure hook -->
                <div class="oe_structure"/>

            </div>
        </xpath>

        <!-- ============================================ -->
        <!-- REEMPLAZAR LA TABLA DE LÍNEAS -->
        <!-- ============================================ -->
        <xpath expr="//table[@name='invoice_line_table']" position="replace">
            <table class="modern-invoice-table table table-sm" name="invoice_line_table">
                <thead>
                    <tr>
                        <th class="text-start">Descripción</th>
                        <th class="text-end">Cantidad</th>
                        <th class="text-end">Precio Unit.</th>
                        <th class="text-end" t-if="any(l.discount for l in o.invoice_line_ids)">Desc.%</th>
                        <th class="text-end">Impuestos</th>
                        <th class="text-end">Importe</th>
                    </tr>
                </thead>
                <tbody class="modern-invoice-tbody">
                    <t t-set="current_subtotal" t-value="0"/>
                    <t t-set="current_total" t-value="0"/>
                    <t t-set="lines" t-value="o.invoice_line_ids.sorted(key=lambda l: (-l.sequence, l.date, l.move_name, -l.id), reverse=True)"/>
                    <t t-set="display_discount" t-value="any(l.discount for l in o.invoice_line_ids)"/>

                    <t t-foreach="lines" t-as="line">
                        <t t-set="current_subtotal" t-value="current_subtotal + line.price_subtotal"/>
                        <t t-set="current_total" t-value="current_total + line.price_total"/>

                        <tr t-att-class="'fw-bold o_line_section' if line.display_type == 'line_section' else 'fst-italic o_line_note' if line.display_type == 'line_note' else ''">
                            <!-- Línea de Producto -->
                            <t t-if="line.display_type == 'product'">
                                <td class="line-description">
                                    <div class="item-name">
                                        <span t-if="line.name" t-field="line.name" t-options="{'widget': 'text'}"/>
                                    </div>
                                    <div class="item-code" t-if="line.product_id.default_code">
                                        <small class="text-muted">Ref: <span t-field="line.product_id.default_code"/></small>
                                    </div>
                                </td>
                                <td class="text-end text-nowrap">
                                    <span t-field="line.quantity"/>
                                    <span t-field="line.product_uom_id" groups="uom.group_uom"/>
                                </td>
                                <td class="text-end">
                                    <span class="text-nowrap" t-field="line.price_unit"/>
                                </td>
                                <td class="text-end" t-if="display_discount">
                                    <span class="text-nowrap" t-field="line.discount"/>
                                </td>
                                <t t-set="taxes" t-value="', '.join([(tax.invoice_label or tax.name) for tax in line.tax_ids])"/>
                                <td class="text-end">
                                    <span t-out="taxes"/>
                                </td>
                                <td class="text-end line-total">
                                    <span class="text-nowrap" t-field="line.price_subtotal"/>
                                </td>
                            </t>

                            <!-- Sección -->
                            <t t-elif="line.display_type == 'line_section'">
                                <td colspan="99" class="section-row">
                                    <span t-if="line.name" t-field="line.name" t-options="{'widget': 'text'}"/>
                                </td>
                                <t t-set="current_section" t-value="line"/>
                                <t t-set="current_subtotal" t-value="0"/>
                            </t>

                            <!-- Nota -->
                            <t t-elif="line.display_type == 'line_note'">
                                <td colspan="99" class="note-row">
                                    <span t-if="line.name" t-field="line.name" t-options="{'widget': 'text'}"/>
                                </td>
                            </t>
                        </tr>

                        <!-- Subtotal de Sección -->
                        <t t-if="current_section and (line_last or lines[line_index+1].display_type == 'line_section')">
                            <tr class="is-subtotal text-end">
                                <td colspan="99">
                                    <strong>Subtotal</strong>
                                    <span t-out="current_subtotal" 
                                          t-options='{"widget": "monetary", "display_currency": o.currency_id}'/>
                                </td>
                            </tr>
                        </t>
                    </t>
                </tbody>
            </table>
        </xpath>

        <!-- ============================================ -->
        <!-- MODERNIZAR SECCIÓN DE TOTALES -->
        <!-- ============================================ -->
        <xpath expr="//div[@id='right-elements']" position="replace">
            <div class="modern-totals-wrapper">
                
                <!-- Notas y Comentarios -->
                <div class="modern-notes-section" t-if="not is_html_empty(o.narration)">
                    <div class="info-card">
                        <h3 class="info-card-title">Observaciones</h3>
                        <div class="info-card-content">
                            <span t-field="o.narration"/>
                        </div>
                    </div>
                </div>

                <!-- Totales -->
                <div class="modern-totals-box">
                    <t t-if="o.tax_totals">
                        <t t-set="tax_totals" t-value="o.tax_totals"/>
                        
                        <!-- Subtotales -->
                        <t t-foreach="tax_totals['subtotals']" t-as="subtotal">
                            <div class="total-line">
                                <span t-out="subtotal['name']"/>
                                <span t-out="subtotal['formatted_amount']"/>
                            </div>
                        </t>

                        <!-- Impuestos -->
                        <t t-foreach="tax_totals['groups_by_subtotal'][tax_totals['subtotals'][0]['name']]" t-as="group">
                            <div class="total-line tax-line">
                                <span t-out="group['tax_group_name']"/>
                                <span t-out="group['formatted_tax_group_amount']"/>
                            </div>
                        </t>

                        <!-- Total Final -->
                        <div class="total-line final-total">
                            <span>TOTAL</span>
                            <span t-out="tax_totals['formatted_amount_total']"/>
                        </div>
                    </t>

                    <!-- Pagos realizados -->
                    <t t-if="print_with_payments and o.payment_state != 'invoicing_legacy'">
                        <t t-set="payments_vals" t-value="o.sudo().invoice_payments_widget and o.sudo().invoice_payments_widget['content'] or []"/>
                        <t t-foreach="payments_vals" t-as="payment_vals">
                            <div class="total-line payment-line" t-if="payment_vals['is_exchange'] == 0">
                                <span>
                                    <i>Pagado el <t t-out="payment_vals['date']" t-options='{"widget": "date"}'/></i>
                                </span>
                                <span t-out="payment_vals['amount']" 
                                      t-options='{"widget": "monetary", "display_currency": o.currency_id}'/>
                            </div>
                        </t>
                        <t t-if="len(payments_vals) > 0">
                            <div class="total-line amount-due">
                                <strong>Saldo Pendiente</strong>
                                <strong t-field="o.amount_residual"/>
                            </div>
                        </t>
                    </t>
                </div>

                <!-- Monto en Palabras -->
                <div class="modern-amount-words" t-if="o.company_id.display_invoice_amount_total_words">
                    <strong>Total en palabras:</strong><br/>
                    <span t-field="o.amount_total_words"/>
                </div>

            </div>
        </xpath>

        <!-- ============================================ -->
        <!-- INFORMACIÓN ADICIONAL AL FINAL -->
        <!-- ============================================ -->
        <xpath expr="//div[@id='payment_term']" position="replace">
            <div class="modern-footer-info">
                
                <!-- Términos de Pago -->
                <div class="payment-terms-section" t-if="o.invoice_payment_term_id.note">
                    <p t-field="o.invoice_payment_term_id.note"/>
                </div>

                <!-- Notas Fiscales -->
                <div class="fiscal-notes" t-if="not is_html_empty(o.fiscal_position_id.note)">
                    <span t-field="o.fiscal_position_id.note"/>
                </div>

                <!-- Notas Legales de Impuestos -->
                <div class="tax-legal-notes" t-if="not is_html_empty(o.taxes_legal_notes)">
                    <span t-field="o.taxes_legal_notes"/>
                </div>

                <!-- QR Code -->
                <t t-set="show_qr" t-value="o.display_qr_code and o.amount_residual > 0"/>
                <div class="qr-code-section" t-if="show_qr">
                    <t t-set="qr_code_url" t-value="o._generate_qr_code(silent_errors=True)"/>
                    <div class="qr-container" t-if="qr_code_url">
                        <div class="qr-image">
                            <img t-att-src="qr_code_url" alt="QR Code"/>
                        </div>
                        <div class="qr-text">
                            <p>Escanea este código QR<br/>con tu aplicación bancaria</p>
                        </div>
                    </div>
                </div>

                <!-- Footer Final -->
                <div class="invoice-footer-text">
                    <p>Factura electrónica generada conforme a la normativa SUNAT</p>
                    <p t-if="o.company_id.website" class="company-website">
                        <span t-field="o.company_id.website"/>
                    </p>
                </div>

                <!-- OE Structure hook -->
                <div class="oe_structure"/>
            </div>
        </xpath>

    </template>

</odoo>