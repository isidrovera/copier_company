<?xml version="1.0" encoding="utf-8"?>
<odoo>

  <!-- ==========================================================
       Reporte PDF: Factura Moderna (Odoo 18)
       Módulo: copier_company
       Encabezado: SOLO logo (sin nombre de empresa)
       Totales: bloque a la derecha
       SPOT: bloque a la izquierda (detracciones)
       ========================================================== -->

  <template id="report_invoice_document_modern">
    <t t-call="web.html_container">
      <t t-foreach="docs" t-as="o">

        <t t-call="web.external_layout">

          <!-- ====== ENCABEZADO (solo logo) ====== -->
          <div style="font-family: Arial, sans-serif; font-size: 12px; color:#000; background:#fff; padding: 16px 20px 0 20px;">
            <table style="width: 100%; border-collapse: collapse; margin-bottom: 10px;">
              <tr>
                <td style="width:60%; vertical-align: middle;">
                  <img t-if="o.company_id.logo"
                       t-att-src="image_data_uri(o.company_id.logo)"
                       style="max-height: 55px; max-width: 160px;"/>
                  <!-- INTENCIONALMENTE no mostramos o.company_id.name -->
                </td>
                <td style="width:40%; text-align: right; vertical-align: top; font-size: 11px;">
                  <div>RUC <span t-esc="o.company_id.vat or ''"/></div>
                  <div style="font-weight: 700; margin-top: 4px;">
                    <span t-if="o.move_type == 'out_invoice'">FACTURA ELECTRÓNICA</span>
                    <span t-elif="o.move_type == 'out_refund'">NOTA DE CRÉDITO</span>
                    <span t-elif="o.move_type == 'in_invoice'">FACTURA PROVEEDOR</span>
                  </div>
                  <div>No. <span t-field="o.name"/></div>
                </td>
              </tr>
            </table>

            <!-- Datos empresa (opcionales, sin fondos) -->
            <table style="width: 100%; border-collapse: collapse; margin-bottom: 6px; font-size: 10px;">
              <tr>
                <td style="padding: 2px 0;">
                  <div t-field="o.company_id.partner_id"
                       t-options='{"widget":"contact","fields":["address"],"no_marker":true}'/>
                  <span t-if="o.company_id.phone">Telf: <span t-esc="o.company_id.phone"/></span>
                  <span t-if="o.company_id.email" style="margin-left: 12px;"><span t-esc="o.company_id.email"/></span>
                </td>
              </tr>
            </table>

            <!-- ====== INFORMACIÓN DEL CLIENTE ====== -->
            <table style="width:100%; border-collapse: collapse; border:1px solid #ccc; font-size:10px; margin-bottom: 14px;">
              <tr>
                <td style="width:18%; padding:7px; border:1px solid #ccc; font-weight:600;">SEÑOR(ES)</td>
                <td style="width:32%; padding:7px; border:1px solid #ccc;"><span t-field="o.partner_id.name"/></td>
                <td style="width:22%; padding:7px; border:1px solid #ccc; font-weight:600;">FECHA DE EMISIÓN</td>
                <td style="width:28%; padding:7px; border:1px solid #ccc;">
                  <span t-field="o.invoice_date" t-options='{"format":"dd/MM/yyyy"}'/>
                </td>
              </tr>
              <tr>
                <td style="padding:7px; border:1px solid #ccc; font-weight:600;">DIRECCIÓN</td>
                <td style="padding:7px; border:1px solid #ccc;">
                  <span t-field="o.partner_id" t-options='{"widget":"contact","fields":["address"],"no_marker":true}'/>
                </td>
                <td style="padding:7px; border:1px solid #ccc; font-weight:600;">VENCIMIENTO</td>
                <td style="padding:7px; border:1px solid #ccc;">
                  <span t-field="o.invoice_date_due" t-options='{"format":"dd/MM/yyyy"}'/>
                </td>
              </tr>
              <tr>
                <td style="padding:7px; border:1px solid #ccc; font-weight:600;">TELÉFONO</td>
                <td style="padding:7px; border:1px solid #ccc;"><span t-esc="o.partner_id.phone or ''"/></td>
                <td style="padding:7px; border:1px solid #ccc; font-weight:600;">RUC/DNI</td>
                <td style="padding:7px; border:1px solid #ccc;"><span t-esc="o.partner_id.vat or ''"/></td>
              </tr>
            </table>

            <!-- ====== LÍNEAS ====== -->
            <t t-set="lines" t-value="o.invoice_line_ids.sorted(key=lambda l: (-l.sequence, l.date, l.move_name, -l.id), reverse=True)"/>
            <table style="width:100%; border-collapse: collapse; border:1px solid #ccc; font-size:11px; margin-bottom: 10px;">
              <thead>
                <tr>
                  <th style="padding:9px; text-align:left; border:1px solid #ccc;">Descripción</th>
                  <th style="padding:9px; text-align:right; border:1px solid #ccc;">Cant.</th>
                  <th style="padding:9px; text-align:right; border:1px solid #ccc;">P. Unit.</th>
                  <th style="padding:9px; text-align:right; border:1px solid #ccc;">Impuestos</th>
                  <th style="padding:9px; text-align:right; border:1px solid #ccc;">Importe</th>
                </tr>
              </thead>
              <tbody>
                <t t-foreach="lines" t-as="line">
                  <t t-if="line.display_type == 'product'">
                    <t t-set="taxes_label" t-value="', '.join([(tax.invoice_label or tax.name) for tax in line.tax_ids])"/>
                    <tr>
                      <td style="padding:8px; border:1px solid #ddd;">
                        <span t-field="line.name" t-options="{'widget':'text'}"/>
                      </td>
                      <td style="padding:8px; border:1px solid #ddd; text-align:right;">
                        <span t-field="line.quantity"/> <span t-field="line.product_uom_id" groups="uom.group_uom"/>
                      </td>
                      <td style="padding:8px; border:1px solid #ddd; text-align:right;">
                        <span t-field="line.price_unit"/>
                      </td>
                      <td style="padding:8px; border:1px solid #ddd; text-align:right;">
                        <span t-out="taxes_label"/>
                      </td>
                      <td style="padding:8px; border:1px solid #ddd; text-align:right; font-weight:600;">
                        <span t-field="line.price_subtotal"/>
                      </td>
                    </tr>
                  </t>
                  <t t-elif="line.display_type == 'line_section'">
                    <tr>
                      <td colspan="5" style="padding:8px; border:1px solid #ddd; font-weight:700;">
                        <span t-field="line.name" t-options="{'widget':'text'}"/>
                      </td>
                    </tr>
                  </t>
                  <t t-elif="line.display_type == 'line_note'">
                    <tr>
                      <td colspan="5" style="padding:8px; border:1px solid #ddd; font-style:italic;">
                        <span t-field="line.name" t-options="{'widget':'text'}"/>
                      </td>
                    </tr>
                  </t>
                </t>
              </tbody>
            </table>

            <!-- ====== MONTO EN PALABRAS (opcional) ====== -->
            <div t-if="o.company_id.display_invoice_amount_total_words"
                 style="font-size:11px; margin: 6px 0 12px 0;">
              <strong>Total en letras:</strong> <span t-field="o.amount_total_words"/>
            </div>

            <!-- ====== LAYOUT INFERIOR: SPOT IZQ + TOTALES DERECHA ====== -->
            <div style="width:100%; display:flex; gap: 20px; align-items:flex-start;">

              <!-- SPOT / DETRACCIONES (Izquierda) -->
              <div style="flex:1; font-size:10px;">
                <div t-if="o.l10n_pe_edi_operation_type == '1001'" style="border:1px solid #ccc; padding:10px; border-radius:4px; margin-bottom:12px;">
                  <div style="font-weight:700; margin-bottom:6px;">
                    Operación sujeta al Sistema de Pago de Obligaciones Tributarias (SPOT)
                  </div>
                  <table style="width:100%; border-collapse:collapse; font-size:10px;">
                    <tr>
                      <td style="padding:4px; border:1px solid #eee;">Código bien o servicio</td>
                      <td style="padding:4px; border:1px solid #eee; font-weight:700;">019</td>
                    </tr>
                    <tr>
                      <td style="padding:4px; border:1px solid #eee;">Nº cuenta Banco de la Nación</td>
                      <td style="padding:4px; border:1px solid #eee; font-weight:700;">00802007582</td>
                    </tr>
                    <tr>
                      <td style="padding:4px; border:1px solid #eee;">Porcentaje de detracción</td>
                      <td style="padding:4px; border:1px solid #eee; font-weight:700;">10.0%</td>
                    </tr>
                    <tr>
                      <td style="padding:4px; border:1px solid #eee;">Monto de detracción</td>
                      <td style="padding:4px; border:1px solid #eee; font-weight:700;">
                        <span t-esc="'S/ %.2f' % ((o.amount_total or 0.0) * 0.10)"/>
                      </td>
                    </tr>
                  </table>
                </div>

                <!-- Términos / notas -->
                <div t-if="o.invoice_payment_term_id" style="margin-bottom:6px;">
                  <strong>Términos de pago:</strong> <span t-field="o.invoice_payment_term_id.name"/>
                </div>
                <div t-if="o.payment_reference" style="margin-bottom:6px;">
                  <strong>Comunicación del pago:</strong> <span t-field="o.payment_reference"/>
                  <t t-if="o.partner_bank_id">
                    <br/>en esta cuenta: <strong><span t-field="o.partner_bank_id"/></strong>
                  </t>
                </div>
                <div class="text-muted" style="font-size:10px; margin-top:8px;" t-if="not is_html_empty(o.narration)">
                  <span t-field="o.narration"/>
                </div>
              </div>

              <!-- TOTALES (Derecha) -->
              <div style="width:320px; flex-shrink:0;">
                <div style="float:right;">
                  <table style="width:100%; border-collapse:collapse;" class="avoid-page-break-inside">

                    <!-- Resumen de impuestos/total (moneda de la factura) -->
                    <t t-if="o.tax_totals" t-call="account.document_tax_totals">
                      <t t-set="tax_totals" t-value="o.tax_totals"/>
                      <t t-set="currency" t-value="o.currency_id"/>
                    </t>

                    <!-- Pagos (si se imprime con pagos) -->
                    <t t-if="print_with_payments">
                      <t t-if="o.payment_state != 'invoicing_legacy'">
                        <t t-set="payments_vals" t-value="o.sudo().invoice_payments_widget and o.sudo().invoice_payments_widget['content'] or []"/>
                        <t t-foreach="payments_vals" t-as="payment_vals">
                          <tr t-if="payment_vals['is_exchange'] == 0">
                            <td style="padding:6px 0;">
                              <i>Pagado el <t t-out="payment_vals['date']" t-options='{"widget":"date"}'/></i>
                            </td>
                            <td style="padding:6px 0; text-align:right;">
                              <span t-out="payment_vals['amount']" t-options='{"widget":"monetary","display_currency":o.currency_id}'/>
                            </td>
                          </tr>
                        </t>
                        <t t-if="len(payments_vals) &gt; 0">
                          <tr style="font-weight:700;">
                            <td>Pendiente</td>
                            <td style="text-align:right;">
                              <span t-field="o.amount_residual"/>
                            </td>
                          </tr>
                        </t>
                      </t>
                    </t>
                  </table>

                  <!-- Resumen en moneda de la compañía (si aplica) -->
                  <t t-if="o.tax_totals.get('display_in_company_currency')">
                    <t t-set="tax_totals" t-value="o.tax_totals"/>
                    <t t-call="account.document_tax_totals_company_currency_template"/>
                  </t>
                </div>
              </div>
            </div>

          </div> <!-- /contenido principal -->
        </t> <!-- /external_layout -->
      </t> <!-- /foreach docs -->
    </t> <!-- /html_container -->
  </template>

  <!-- Acción del reporte -->
  <record id="action_report_invoice_modern" model="ir.actions.report">
    <field name="name">Factura Moderna</field>
    <field name="model">account.move</field>
    <field name="report_type">qweb-pdf</field>
    <!-- IMPORTANT: apunta al template anterior -->
    <field name="report_name">copier_company.report_invoice_document_modern</field>
    <field name="report_file">copier_company.report_invoice_document_modern</field>
    <field name="binding_model_id" ref="account.model_account_move"/>
    <field name="binding_type">report</field>
  </record>

</odoo>
