<?xml version="1.0" encoding="UTF-8"?>
<odoo>
    <!-- Kanban View -->
    <record id="view_copier_counter_kanban" model="ir.ui.view">
        <field name="name">copier.counter.kanban</field>
        <field name="model">copier.counter</field>
        <field name="arch" type="xml">
            <kanban
                class="o_kanban_mobile"
                sample="1"
                default_group_by="state">
                <field name="name" />
                <field name="cliente_id" />
                <field name="serie" />
                <field name="fecha_facturacion" />
                <field name="mes_facturacion" />
                <field name="state" />
                <field name="total" />
                <field name="currency_id" />
                <progressbar
                    field="state"
                    colors='{
                        "draft": "success",
                        "confirmed": "info",
                        "invoiced": "warning",
                        "cancelled": "danger"}' />
                <templates>
                    <t t-name="kanban-box">
                        <div class="oe_kanban_global_click p-0">
                            <div class="oe_kanban_details p-3">
                                <div class="o_kanban_record_top mb-2">
                                    <div class="o_kanban_record_headings">
                                        <strong class="o_kanban_record_title">
                                            <span class="text-primary">
                                                <field name="name" />
                                            </span>
                                        </strong>
                                    </div>
                                </div>
                                <div class="row mb-2">
                                    <div class="col-6">
                                        <strong>Cliente:</strong>
                                        <field name="cliente_id" />
                                    </div>
                                    <div class="col-6">
                                        <strong>Serie:</strong>
                                        <field name="serie" />
                                    </div>
                                </div>
                                <div class="row mb-2">
                                    <div class="col-6">
                                        <field name="mes_facturacion" />
                                    </div>
                                    <div class="col-6 text-end">
                                        <field name="total" widget="monetary" />
                                    </div>
                                </div>
                                <div class="o_kanban_record_bottom">
                                    <div class="oe_kanban_bottom_left">
                                        <span
                                            t-attf-class="badge rounded-pill bg-#{
                                            record.state.raw_value == 'confirmed' ? 'success' : 
                                            record.state.raw_value == 'draft' ? 'info' : 
                                            record.state.raw_value == 'invoiced' ? 'warning' : 'danger'}">
                                            <field name="state" />
                                        </span>
                                    </div>
                                    <div class="oe_kanban_bottom_right">
                                        <field name="fecha_facturacion" widget="date" />
                                    </div>
                                </div>
                            </div>
                        </div>
                    </t>
                </templates>
            </kanban>
        </field>
    </record>

    <!-- Tree/List View -->
    <record id="view_copier_counter_tree" model="ir.ui.view">
        <field name="name">copier.counter.tree</field>
        <field name="model">copier.counter</field>
        <field name="arch" type="xml">
            <list decoration-info="state == 'draft'"
                decoration-success="state == 'confirmed'"
                decoration-warning="state == 'invoiced'"
                decoration-danger="state == 'cancelled'"
                sample="1">

                <!--<field name="name" widget="many2one_avatar_user" />-->
                <field name="cliente_id" optional="hide" />
                <field name="maquina_id" />
                <field name="serie" />
                <field name="mes_facturacion" optional="hide" />
                <field name="contador_actual_bn" sum="Total B/N" optional="hide"/>
                <field name="total_copias_bn" sum="Total Copias B/N" />
                <field name="copias_facturables_bn" sum="Total Facturable B/N" optional="hide"/>
                <field name="contador_actual_color" sum="Total Color" optional="hide"/>
                <field name="total_copias_color" sum="Total Copias Color" />
                <field name="copias_facturables_color" sum="Total Facturable Color" />
                
                <field name="subtotal" sum="Subtotal" widget="monetary" optional="hide"/>
                <field name="total" sum="Total" widget="monetary" />
                <field name="currency_id" optional="hide"/>
                <field name="state" widget="badge"
                    decoration-info="state == 'draft'"
                    decoration-success="state == 'confirmed'"
                    decoration-warning="state == 'invoiced'"
                    decoration-danger="state == 'cancelled'" />
            </list>
        </field>
    </record>

    <!-- Form View -->
    <record id="view_copier_counter_form" model="ir.ui.view">
    <field name="name">copier.counter.form</field>
    <field name="model">copier.counter</field>
    <field name="arch" type="xml">
        <form>
            <header>
                <button name="action_confirm"
                    string="Confirmar"
                    type="object"
                    class="btn btn-primary"
                    column_invisible="state != 'draft'" />
                <button name="action_draft"
                    string="Volver a Borrador"
                    type="object"
                    class="btn btn-secondary"
                    column_invisible="state != 'confirmed'" />
                <button name="action_cancel"
                    string="Cancelar"
                    type="object"
                    class="btn btn-outline-danger"
                    column_invisible="state not in ('draft', 'confirmed')" />
                <button string=" Reporte" 
                    name="action_print_report" 
                    type="object"
                    class="btn btn-info" />
                <button name="action_create_invoice" 
                    type="object" 
                    string=" Crear Factura"
                    class="btn btn-success"
                    column_invisible="state != 'confirmed'"/>
                <button name="debug_urgente_counter" 
                    string=" Debug Counter" 
                    type="object" 
                    class="btn btn-warning"
                    help="Debug urgente para identificar discrepancia en totales"/>

                <field name="state" widget="statusbar"
                    statusbar_visible="draft,confirmed,invoiced" />
            </header>
            <sheet>
                <div class="oe_title">
                    <h1>
                        <field name="name" readonly="1" class="text-primary fw-bold" />
                    </h1>
                </div>
                
                <!-- Informaci贸n Principal -->
                <div class="row">
                    <div class="col-lg-6">
                        <group string=" Informaci贸n General" class="bg-light p-3 rounded">
                            <field name="maquina_id" readonly="state != 'draft'" />
                            <field name="cliente_id" />
                            <field name="serie" />
                            <field name="fecha" readonly="state != 'draft'" />
                            <field name="fecha_facturacion" readonly="state != 'draft'" />
                            <field name="mes_facturacion" />
                            <field name="fecha_emision_factura" 
       help="Deja vac铆o para usar la fecha de hoy al facturar"
       readonly="state == 'invoiced'"/>
                        </group>
                    </div>
                    <div class="col-lg-6">
                        <group string=" Gesti贸n de Usuarios" class="bg-info bg-opacity-10 p-3 rounded">
                            <field name="informe_por_usuario" widget="boolean_toggle"/>
                            <button name="cargar_usuarios_asociados" 
                                    string="Cargar Usuarios Asociados"
                                    type="object" 
                                    class="btn btn-primary"
                                    invisible="not informe_por_usuario or state != 'draft'"/>
                        </group>
                    </div>
                </div>

                <field name="currency_id" invisible="1" />

                <!-- Detalle de Usuarios - Solo visible cuando informe_por_usuario est谩 activado -->
                <div class="mt-3">
                    <field name="usuario_detalle_ids" invisible="not informe_por_usuario">
                        <list editable="bottom" decoration-info="True" class="table-striped">
                            <field name="usuario_id" readonly="1"/>
                            <field name="cantidad_copias" sum="Total de Copias" class="text-end"/>
                        </list>
                    </field>
                </div>

                <notebook class="mt-4">
                    <page string=" Contadores B/N" name="contadores_bn">
                        <div class="card border-dark">
                            <div class="card-header bg-dark text-white">
                                <h5 class="mb-0">Contadores Blanco y Negro</h5>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-6">
                                        <group string="Contadores">
                                            <field name="contador_anterior_bn" class="form-control-lg"/>
                                            <field name="contador_actual_bn" 
                                                   readonly="state != 'draft'" 
                                                   class="form-control-lg"/>
                                            <field name="total_copias_bn" 
                                                   class="fw-bold text-primary form-control-lg"/>
                                        </group>
                                    </div>
                                    <div class="col-md-6">
                                        <group string="Facturaci贸n">
                                            <field name="exceso_bn" class="text-warning"/>
                                            <field name="copias_facturables_bn" class="text-success"/>
                                            <field name="precio_bn_sin_igv" widget="monetary" class="text-info"/>
                                        </group>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </page>
                    
                    <page string=" Contadores Color" name="contadores_color">
                        <div class="card border-primary">
                            <div class="card-header bg-primary text-white">
                                <h5 class="mb-0">Contadores a Color</h5>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-6">
                                        <group string="Contadores">
                                            <field name="contador_anterior_color" class="form-control-lg"/>
                                            <field name="contador_actual_color" 
                                                   readonly="state != 'draft'" 
                                                   class="form-control-lg"/>
                                            <field name="total_copias_color" 
                                                   class="fw-bold text-primary form-control-lg"/>
                                        </group>
                                    </div>
                                    <div class="col-md-6">
                                        <group string="Facturaci贸n">
                                            <field name="exceso_color" class="text-warning"/>
                                            <field name="copias_facturables_color" class="text-success"/>
                                            <field name="precio_color_sin_igv" widget="monetary" class="text-info"/>
                                        </group>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </page>
                    
                    <page string=" Totales" name="totales">
                        <div class="card border-success">
                            <div class="card-header bg-success text-white">
                                <h5 class="mb-0">Resumen Financiero</h5>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-6">
                                        <group class="oe_subtotal_footer bg-light p-3 rounded">
                                            <field name="subtotal" 
                                                   widget="monetary" 
                                                   class="fs-5 text-primary"/>
                                            <field name="igv" 
                                                   widget="monetary" 
                                                   class="fs-5 text-info"/>
                                            <field name="total" 
                                                   class="oe_subtotal_footer_separator fw-bold fs-4 text-success"
                                                   widget="monetary" />
                                        </group>
                                    </div>
                                    <div class="col-md-6">
                                        <separator string=" Informaci贸n de Facturaci贸n" class="text-muted"/>
                                        <group col="1" class="mt-3">
                                            <field name="producto_facturable_id" 
                                                   readonly="1" 
                                                   class="fw-semibold"/>
                                            <field name="precio_producto" 
                                                   readonly="1" 
                                                   widget="monetary"
                                                   class="text-success"/>
                                        </group>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </page>
                </notebook>
            </sheet>
            <chatter />
        </form>
    </field>
</record>
    <!-- Search View -->
<record id="view_copier_counter_search" model="ir.ui.view">
    <field name="name">copier.counter.search</field>
    <field name="model">copier.counter</field>
    <field name="arch" type="xml">
        <search>
            <field name="name" />
            <field name="cliente_id" />
            <field name="serie" />
            <field name="mes_facturacion" />
            <filter string="Borradores" name="draft" domain="[('state','=','draft')]" />
            <filter string="Confirmados" name="confirmed" domain="[('state','=','confirmed')]" />
            <filter string="Facturados" name="invoiced" domain="[('state','=','invoiced')]" />
            <filter string="Cancelados" name="cancelled" domain="[('state','=','cancelled')]" />
            <separator />
            
        </search>
    </field>
</record>


</odoo>