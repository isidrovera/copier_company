<?xml version="1.0" encoding="UTF-8"?>
<odoo>
    <!-- Kanban View Mejorada -->
    <record id="view_copier_counter_kanban" model="ir.ui.view">
        <field name="name">copier.counter.kanban</field>
        <field name="model">copier.counter</field>
        <field name="arch" type="xml">
            <kanban
                class="o_kanban_mobile"
                sample="1"
                default_group_by="state"
                quick_create="false">
                <field name="name" />
                <field name="cliente_id" />
                <field name="serie" />
                <field name="fecha_facturacion" />
                <field name="mes_facturacion" />
                <field name="state" />
                <field name="total" />
                <field name="currency_id" />
                <field name="total_copias_bn" />
                <field name="total_copias_color" />
                <progressbar
                    field="state"
                    colors='{
                        "draft": "info",
                        "confirmed": "success",
                        "invoiced": "warning",
                        "cancelled": "danger"}' />
                <templates>
                    <t t-name="kanban-box">
                        <div class="oe_kanban_global_click">
                            <div class="o_kanban_card d-flex flex-column">
                                <!-- Header -->
                                <div class="o_kanban_card_header">
                                    <div class="o_kanban_card_header_title">
                                        <div class="o_primary">
                                            <strong><field name="name" /></strong>
                                        </div>
                                        <div class="text-muted">
                                            <field name="serie" />
                                        </div>
                                    </div>
                                    <div class="o_kanban_manage_button_section">
                                        <a class="o_kanban_manage_toggle_button" href="#" tabindex="-1">
                                            <i class="fa fa-ellipsis-v" role="img" aria-label="Manage" title="Manage"/>
                                        </a>
                                    </div>
                                </div>

                                <!-- Content -->
                                <div class="o_kanban_card_content">
                                    <div class="o_kanban_primary_left">
                                        <div class="o_primary">
                                            <field name="cliente_id" />
                                        </div>
                                        <div class="text-muted">
                                            <field name="mes_facturacion" />
                                        </div>
                                        <div class="mt-2">
                                            <span class="badge badge-pill badge-info me-1">
                                                B/N: <field name="total_copias_bn" />
                                            </span>
                                            <span class="badge badge-pill badge-warning">
                                                Color: <field name="total_copias_color" />
                                            </span>
                                        </div>
                                    </div>
                                </div>

                                <!-- Footer -->
                                <div class="o_kanban_card_manage_pane dropdown-menu" role="menu">
                                    <div class="o_kanban_card_manage_section o_kanban_manage_reports">
                                        <div role="menuitem" aria-haspopup="true">
                                            <a name="action_print_report" type="object">Imprimir Reporte</a>
                                        </div>
                                    </div>
                                    <div class="o_kanban_card_manage_section o_kanban_manage_new">
                                        <div role="menuitem" aria-haspopup="true" invisible="state != 'confirmed'">
                                            <a name="action_create_invoice" type="object">Crear Factura</a>
                                        </div>
                                    </div>
                                </div>

                                <div class="o_kanban_card_footer">
                                    <div class="o_kanban_primary_bottom_left">
                                        <field name="state" widget="label_selection"
                                            options="{'classes': {
                                                'draft': 'info',
                                                'confirmed': 'success',
                                                'invoiced': 'warning',
                                                'cancelled': 'danger'}}" />
                                    </div>
                                    <div class="o_kanban_primary_bottom_right">
                                        <field name="total" widget="monetary" />
                                    </div>
                                </div>
                            </div>
                        </div>
                    </t>
                </templates>
            </kanban>
        </field>
    </record>

    <!-- Tree/List View Mejorada -->
    <record id="view_copier_counter_tree" model="ir.ui.view">
        <field name="name">copier.counter.tree</field>
        <field name="model">copier.counter</field>
        <field name="arch" type="xml">
            <list decoration-info="state == 'draft'"
                  decoration-success="state == 'confirmed'"
                  decoration-warning="state == 'invoiced'"
                  decoration-danger="state == 'cancelled'"
                  sample="1"
                  multi_edit="1"
                  export_xlsx="1">

                <field name="name" />
                <field name="cliente_id" optional="hide" />
                <field name="maquina_id" />
                <field name="serie" />
                <field name="fecha_facturacion" />
                <field name="mes_facturacion" optional="hide" />
                
                <!-- Contadores B/N -->
                <field name="contador_anterior_bn" optional="hide" />
                <field name="contador_actual_bn" sum="Total B/N" optional="hide" />
                <field name="total_copias_bn" sum="Total Copias B/N" />
                <field name="copias_facturables_bn" sum="Total Facturable B/N" optional="hide" />
                
                <!-- Contadores Color -->
                <field name="contador_anterior_color" optional="hide" />
                <field name="contador_actual_color" sum="Total Color" optional="hide" />
                <field name="total_copias_color" sum="Total Copias Color" />
                <field name="copias_facturables_color" sum="Total Facturable Color" />
                
                <!-- Financiero -->
                <field name="subtotal_antes_descuento" sum="Subtotal Antes" widget="monetary" optional="hide" />
                <field name="monto_descuento" sum="Descuento" widget="monetary" optional="hide" />
                <field name="descuento_porcentaje" optional="hide" string="Desc. %" />
                <field name="subtotal" sum="Subtotal" widget="monetary" optional="hide" />
                <field name="igv" sum="IGV" widget="monetary" optional="hide" />
                <field name="total" sum="Total" widget="monetary" />
                
                <field name="currency_id" column_invisible="True" />
                <field name="state" widget="badge"
                    decoration-info="state == 'draft'"
                    decoration-success="state == 'confirmed'"
                    decoration-warning="state == 'invoiced'"
                    decoration-danger="state == 'cancelled'" />

                <!-- Botones de acciÃ³n por registro -->
                <button name="action_confirm"
                    string="Confirmar"
                    type="object"
                    class="btn-primary"
                    invisible="state != 'draft'"
                    icon="fa-check" />
                
                <button name="action_create_invoice"
                    string="Facturar"
                    type="object"
                    class="btn-success"
                    invisible="state != 'confirmed'"
                    icon="fa-file-invoice-dollar" />

                <button name="action_print_report"
                    string="Reporte"
                    type="object"
                    class="btn-info"
                    icon="fa-print" />
            </list>
        </field>
    </record>

    <!-- Form View Completamente Mejorada -->
    <record id="view_copier_counter_form" model="ir.ui.view">
        <field name="name">copier.counter.form</field>
        <field name="model">copier.counter</field>
        <field name="arch" type="xml">
            <form>
                <header>
                    <!-- Botones de Estado -->
                    <button name="action_confirm"
                        string="âœ… Confirmar"
                        type="object"
                        class="btn-primary"
                        invisible="state != 'draft'"
                        help="Confirma la lectura de contadores" />
                    
                    <button name="action_draft"
                        string="ðŸ“ Volver a Borrador"
                        type="object"
                        class="btn-secondary"
                        invisible="state not in ('confirmed', 'cancelled')"
                        help="Regresa la lectura a estado borrador" />
                    
                    <button name="action_cancel"
                        string="âŒ Cancelar"
                        type="object"
                        class="btn-outline-danger"
                        invisible="state in ('invoiced', 'cancelled')"
                        confirm="Â¿EstÃ¡ seguro que desea cancelar esta lectura?"
                        help="Cancela la lectura del contador" />

                    <!-- Botones de AcciÃ³n -->
                    <button name="action_create_invoice"
                        string="ðŸ’° Crear Factura"
                        type="object"
                        class="btn-success"
                        invisible="state != 'confirmed'"
                        help="Genera factura basada en esta lectura" />

                    <button name="action_print_report"
                        string="ðŸ“„ Imprimir Reporte"
                        type="object"
                        class="btn-info"
                        help="Genera reporte de lectura" />

                    <!-- Botones de Debug (solo en modo desarrollador) -->
                    <button name="debug_counter_totales"
                        string="ðŸ” Debug Totales"
                        type="object"
                        class="btn-warning"
                        invisible="not context.get('debug', False)"
                        help="Debug de cÃ¡lculos financieros" />

                    <field name="state" widget="statusbar"
                        statusbar_visible="draft,confirmed,invoiced" />
                </header>

                <sheet>
                    <div class="oe_button_box" name="button_box">
                        <!-- Widget de informaciÃ³n rÃ¡pida -->
                        <div class="oe_stat_button" icon="fa-calculator">
                            <field name="total" widget="statinfo" string="Total a Facturar" />
                        </div>
                        <div class="oe_stat_button" icon="fa-copy">
                            <field name="total_copias_bn" widget="statinfo" string="Copias B/N" />
                        </div>
                        <div class="oe_stat_button" icon="fa-palette">
                            <field name="total_copias_color" widget="statinfo" string="Copias Color" />
                        </div>
                    </div>

                    <!-- TÃ­tulo -->
                    <div class="oe_title">
                        <h1>
                            <field name="name" readonly="1" class="text-primary" />
                        </h1>
                        <h3 class="text-muted">
                            <field name="mes_facturacion" readonly="1" />
                        </h3>
                    </div>

                    <!-- InformaciÃ³n Principal -->
                    <group>
                        <group string="ðŸ“‹ InformaciÃ³n General">
                            <field name="maquina_id"
                                readonly="state != 'draft'"
                                required="True"
                                options="{'no_create': True, 'no_edit': True}" />
                            <field name="cliente_id" readonly="1" />
                            <field name="serie" readonly="1" />
                            <field name="payment_term_id" readonly="1" />
                            <field name="currency_id" readonly="1" />
                        </group>
                        
                        <group string="ðŸ“… Fechas">
                            <field name="fecha"
                                readonly="state != 'draft'"
                                required="True" />
                            <field name="fecha_facturacion"
                                readonly="state not in ('draft', 'confirmed')"
                                required="True" />
                            <field name="fecha_emision_factura"
                                readonly="state == 'invoiced'"
                                help="Fecha que aparecerÃ¡ en la factura. Si estÃ¡ vacÃ­o, usa la fecha actual" />
                        </group>
                    </group>

                    <!-- GestiÃ³n de Usuarios -->
                    <group string="ðŸ‘¥ Detalle por Usuario" invisible="state == 'invoiced'">
                        <div class="row">
                            <div class="col-md-6">
                                <field name="informe_por_usuario" widget="boolean_toggle" />
                            </div>
                            <div class="col-md-6">
                                <button name="cargar_usuarios_asociados"
                                    string="ðŸ”„ Cargar Usuarios"
                                    type="object"
                                    class="btn-primary"
                                    invisible="not informe_por_usuario or state != 'draft'"
                                    help="Carga usuarios asociados a la mÃ¡quina" />
                            </div>
                        </div>
                    </group>

                    <!-- Detalle de Usuarios -->
                    <field name="usuario_detalle_ids"
                        invisible="not informe_por_usuario"
                        readonly="state != 'draft'">
                        <tree editable="bottom" decoration-info="True">
                            <field name="usuario_id" readonly="1" />
                            <field name="cantidad_copias" sum="Total de Copias" />
                            <field name="notas" optional="hide" />
                        </tree>
                    </field>

                    <!-- Notebook con pestaÃ±as mejoradas -->
                    <notebook>
                        <!-- PestaÃ±a Contadores B/N -->
                        <page string="âš« Contadores B/N" name="contadores_bn">
                            <div class="row">
                                <div class="col-lg-6">
                                    <group string="ðŸ“Š Contadores" class="o_setting_box">
                                        <div class="o_setting_left_pane">
                                            <field name="contador_anterior_bn" class="o_light_label" />
                                        </div>
                                        <div class="o_setting_right_pane">
                                            <field name="contador_actual_bn"
                                                readonly="state != 'draft'"
                                                required="True"
                                                class="o_input_9ch" />
                                        </div>
                                    </group>
                                    
                                    <separator string="ðŸ“ˆ Resultado" />
                                    <group>
                                        <field name="total_copias_bn"
                                            readonly="1"
                                            class="text-primary fw-bold" />
                                        <field name="exceso_bn"
                                            readonly="1"
                                            class="text-warning"
                                            invisible="exceso_bn == 0" />
                                        <field name="copias_facturables_bn"
                                            readonly="1"
                                            class="text-success fw-bold" />
                                    </group>
                                </div>

                                <div class="col-lg-6">
                                    <group string="ðŸ’° FacturaciÃ³n B/N">
                                        <field name="precio_bn_sin_igv"
                                            readonly="1"
                                            widget="monetary" />
                                        <field name="producto_facturable_bn_id"
                                            readonly="1"
                                            invisible="not producto_facturable_bn_id" />
                                        <separator string="ðŸ’µ Totales B/N" />
                                        <field name="subtotal_bn"
                                            readonly="1"
                                            widget="monetary"
                                            class="text-info" />
                                        <field name="igv_bn"
                                            readonly="1"
                                            widget="monetary"
                                            class="text-warning" />
                                        <field name="total_bn"
                                            readonly="1"
                                            widget="monetary"
                                            class="text-success fw-bold" />
                                    </group>
                                </div>
                            </div>
                        </page>

                        <!-- PestaÃ±a Contadores Color -->
                        <page string="ðŸŒˆ Contadores Color" name="contadores_color">
                            <div class="row">
                                <div class="col-lg-6">
                                    <group string="ðŸ“Š Contadores" class="o_setting_box">
                                        <div class="o_setting_left_pane">
                                            <field name="contador_anterior_color" class="o_light_label" />
                                        </div>
                                        <div class="o_setting_right_pane">
                                            <field name="contador_actual_color"
                                                readonly="state != 'draft'"
                                                class="o_input_9ch" />
                                        </div>
                                    </group>
                                    
                                    <separator string="ðŸ“ˆ Resultado" />
                                    <group>
                                        <field name="total_copias_color"
                                            readonly="1"
                                            class="text-primary fw-bold" />
                                        <field name="exceso_color"
                                            readonly="1"
                                            class="text-warning"
                                            invisible="exceso_color == 0" />
                                        <field name="copias_facturables_color"
                                            readonly="1"
                                            class="text-success fw-bold" />
                                    </group>
                                </div>

                                <div class="col-lg-6">
                                    <group string="ðŸ’° FacturaciÃ³n Color">
                                        <field name="precio_color_sin_igv"
                                            readonly="1"
                                            widget="monetary" />
                                        <field name="producto_facturable_color_id"
                                            readonly="1"
                                            invisible="not producto_facturable_color_id" />
                                        <separator string="ðŸ’µ Totales Color" />
                                        <field name="subtotal_color"
                                            readonly="1"
                                            widget="monetary"
                                            class="text-info" />
                                        <field name="igv_color"
                                            readonly="1"
                                            widget="monetary"
                                            class="text-warning" />
                                        <field name="total_color"
                                            readonly="1"
                                            widget="monetary"
                                            class="text-success fw-bold" />
                                    </group>
                                </div>
                            </div>
                        </page>

                        <!-- PestaÃ±a Totales Financieros -->
                        <page string="ðŸ’° Totales" name="totales">
                            <div class="row">
                                <div class="col-lg-8">
                                    <group string="ðŸ“Š Desglose Financiero" class="oe_subtotal_footer oe_right">
                                        <field name="subtotal_antes_descuento"
                                            readonly="1"
                                            widget="monetary"
                                            invisible="subtotal_antes_descuento == 0" />
                                        <field name="descuento_porcentaje"
                                            readonly="1"
                                            string="Descuento"
                                            widget="percentage"
                                            invisible="descuento_porcentaje == 0" />
                                        <field name="monto_descuento"
                                            readonly="1"
                                            widget="monetary"
                                            invisible="monto_descuento == 0"
                                            class="text-danger" />
                                        <field name="subtotal"
                                            readonly="1"
                                            widget="monetary"
                                            class="text-primary" />
                                        <field name="igv"
                                            readonly="1"
                                            widget="monetary"
                                            string="IGV (18%)"
                                            class="text-info" />
                                        <field name="total"
                                            readonly="1"
                                            widget="monetary"
                                            class="oe_subtotal_footer_separator text-success fw-bold fs-4" />
                                    </group>
                                </div>

                                <div class="col-lg-4">
                                    <group string="ðŸ“‹ Productos para FacturaciÃ³n">
                                        <field name="producto_facturable_id"
                                            readonly="1"
                                            invisible="not producto_facturable_id" />
                                        <field name="precio_producto"
                                            readonly="1"
                                            widget="monetary"
                                            invisible="not precio_producto" />
                                    </group>

                                    <!-- InformaciÃ³n adicional -->
                                    <div class="alert alert-info" invisible="state != 'confirmed'">
                                        <strong>ðŸ’¡ InformaciÃ³n:</strong><br/>
                                        Esta lectura estÃ¡ confirmada y lista para facturar.
                                        Use el botÃ³n "Crear Factura" para generar la factura.
                                    </div>

                                    <div class="alert alert-success" invisible="state != 'invoiced'">
                                        <strong>âœ… Facturado:</strong><br/>
                                        Esta lectura ya ha sido facturada.
                                    </div>
                                </div>
                            </div>
                        </page>

                        <!-- PestaÃ±a de ConfiguraciÃ³n Avanzada -->
                        <page string="âš™ï¸ ConfiguraciÃ³n" name="config" invisible="not context.get('debug', False)">
                            <group string="ðŸ”§ ConfiguraciÃ³n TÃ©cnica">
                                <field name="maquina_id" readonly="1" />
                                <separator string="ðŸ” Debug Info" />
                                <div class="row">
                                    <div class="col-6">
                                        <button name="debug_counter_totales"
                                            string="Debug Totales"
                                            type="object"
                                            class="btn-warning" />
                                    </div>
                                </div>
                            </group>
                        </page>
                    </notebook>
                </sheet>

                <!-- Chatter para comunicaciÃ³n -->
                <div class="oe_chatter">
                    <field name="message_follower_ids" />
                    <field name="activity_ids" />
                    <field name="message_ids" />
                </div>
            </form>
        </field>
    </record>

    <!-- Search View Mejorada -->
    <record id="view_copier_counter_search" model="ir.ui.view">
        <field name="name">copier.counter.search</field>
        <field name="model">copier.counter</field>
        <field name="arch" type="xml">
            <search>
                <!-- Campos de bÃºsqueda -->
                <field name="name" string="Referencia" />
                <field name="cliente_id" string="Cliente" />
                <field name="serie" string="Serie" />
                <field name="mes_facturacion" string="Mes" />
                <field name="maquina_id" string="MÃ¡quina" />

                <!-- Filtros principales -->
                <filter string="ðŸ“ Borradores"
                    name="draft"
                    domain="[('state','=','draft')]" />
                <filter string="âœ… Confirmados"
                    name="confirmed"
                    domain="[('state','=','confirmed')]" />
                <filter string="ðŸ’° Facturados"
                    name="invoiced"
                    domain="[('state','=','invoiced')]" />
                <filter string="âŒ Cancelados"
                    name="cancelled"
                    domain="[('state','=','cancelled')]" />

                <separator />

                <!-- Filtros por fecha -->
                <filter string="Este mes"
                    name="this_month"
                    domain="[('fecha_facturacion', '&gt;=', (context_today() - datetime.timedelta(days=30)).strftime('%Y-%m-01')),
                            ('fecha_facturacion', '&lt;=', (context_today().replace(day=1) + datetime.timedelta(days=32)).replace(day=1) - datetime.timedelta(days=1))]" />
                <filter string="Mes pasado"
                    name="last_month"
                    domain="[('fecha_facturacion', '&gt;=', (context_today().replace(day=1) - datetime.timedelta(days=1)).replace(day=1)),
                            ('fecha_facturacion', '&lt;=', context_today().replace(day=1) - datetime.timedelta(days=1))]" />

                <separator />

                <!-- Filtros por volumen -->
                <filter string="Con exceso B/N"
                    name="exceso_bn"
                    domain="[('exceso_bn', '&gt;', 0)]" />
                <filter string="Con exceso Color"
                    name="exceso_color"
                    domain="[('exceso_color', '&gt;', 0)]" />

                <separator />

                <!-- Filtros por montos -->
                <filter string="Montos altos (&gt; 1000)"
                    name="high_amounts"
                    domain="[('total', '&gt;', 1000)]" />

                <!-- Agrupar por -->
                <group expand="0" string="Agrupar por">
                    <filter string="Estado" name="group_state" context="{'group_by': 'state'}" />
                    <filter string="Cliente" name="group_client" context="{'group_by': 'cliente_id'}" />
                    <filter string="MÃ¡quina" name="group_machine" context="{'group_by': 'maquina_id'}" />
                    <filter string="Mes de FacturaciÃ³n" name="group_month" context="{'group_by': 'mes_facturacion'}" />
                    <filter string="Fecha de FacturaciÃ³n" name="group_date" context="{'group_by': 'fecha_facturacion'}" />
                </group>
            </search>
        </field>
    </record>

    <!-- Pivot View para anÃ¡lisis -->
    <record id="view_copier_counter_pivot" model="ir.ui.view">
        <field name="name">copier.counter.pivot</field>
        <field name="model">copier.counter</field>
        <field name="arch" type="xml">
            <pivot string="AnÃ¡lisis de Contadores">
                <field name="cliente_id" type="row" />
                <field name="mes_facturacion" type="col" />
                <field name="total_copias_bn" type="measure" />
                <field name="total_copias_color" type="measure" />
                <field name="total" type="measure" />
            </pivot>
        </field>
    </record>

    <!-- Graph View para reportes visuales -->
    <record id="view_copier_counter_graph" model="ir.ui.view">
        <field name="name">copier.counter.graph</field>
        <field name="model">copier.counter</field>
        <field name="arch" type="xml">
            <graph string="EvoluciÃ³n de Contadores">
                <field name="fecha_facturacion" type="row" />
                <field name="total_copias_bn" type="measure" />
                <field name="total_copias_color" type="measure" />
                <field name="total" type="measure" />
            </graph>
        </field>
    </record>
</odoo>