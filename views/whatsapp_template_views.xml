<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <!-- ========================================= -->
    <!-- VISTA FORMULARIO - PLANTILLA -->
    <!-- ========================================= -->
    <record id="view_whatsapp_template_form" model="ir.ui.view">
        <field name="name">whatsapp.template.form</field>
        <field name="model">whatsapp.template</field>
        <field name="arch" type="xml">
            <form string="Plantilla WhatsApp">
                <header>
                    <button name="action_test_template" 
                            string="üß™ Probar Plantilla" 
                            type="object" 
                            class="oe_highlight"/>
                    <button name="action_duplicate_template" 
                            string="üìã Duplicar" 
                            type="object"/>
                    <field name="active" widget="boolean_button" 
                           options="{'terminology': 'archive'}"/>
                </header>
                <sheet>
                    <widget name="web_ribbon" title="Inactivo" bg_color="text-bg-danger" invisible="active"/>
                    
                    <div class="oe_button_box" name="button_box">
                        <button name="action_view_notifications" 
                                type="object" 
                                class="oe_stat_button" 
                                icon="fa-paper-plane">
                            <field name="notification_count" widget="statinfo" string="Notificaciones"/>
                        </button>
                    </div>
                    
                    <div class="oe_title">
                        <label for="name" string="Plantilla"/>
                        <h1>
                            <field name="name" placeholder="Nombre de la plantilla..."/>
                        </h1>
                        <div>
                            <field name="code" placeholder="codigo_tecnico_unico"/>
                            <span class="text-muted"> - </span>
                            <field name="description" placeholder="Descripci√≥n breve..."/>
                        </div>
                    </div>
                    
                    <group>
                        <group name="basic" string="üì¶ Modelo Objetivo">
                            <field name="model_id" options="{'no_create': True}"/>
                            <field name="model_name" readonly="1"/>
                            <field name="sequence"/>
                        </group>
                        
                        <group name="config" string="‚öôÔ∏è Configuraci√≥n">
                            <field name="config_id" options="{'no_create': True}"/>
                            <field name="auto_apply"/>
                            <field name="log_in_chatter"/>
                            <field name="last_notification_date" readonly="1"/>
                        </group>
                    </group>
                    
                    <notebook>
                        <!-- TAB 1: MENSAJE -->
                        <page string="üí¨ Mensaje" name="message">
                            <group>
                                <group string="Plantilla del Mensaje" colspan="2">
                                    <field name="message_template" 
                                           widget="text" 
                                           placeholder="Escribe tu mensaje aqu√≠. Usa variables como {campo} o {related.campo}"
                                           nolabel="1"/>
                                    <div class="alert alert-info" role="alert">
                                        <strong>üí° Variables disponibles:</strong>
                                        <ul>
                                            <li>Campos simples: <code>{"{nombre_campo}"}</code></li>
                                            <li>Campos relacionados: <code>{"{partner_id.name}"}</code>, <code>{"{cliente_id.mobile}"}</code></li>
                                            <li>M√∫ltiples niveles: <code>{"{partner_id.country_id.name}"}</code></li>
                                        </ul>
                                    </div>
                                </group>
                                
                                <group string="Vista Previa" colspan="2">
                                    <field name="test_record_id" placeholder="ID del registro para preview"/>
                                    <field name="preview_message" 
                                           widget="text" 
                                           readonly="1" 
                                           nolabel="1"
                                           placeholder="Ingresa un ID de registro para ver la vista previa"/>
                                </group>
                                
                                <group string="üìã Campos Disponibles" colspan="2">
                                    <field name="available_fields_info" 
                                           widget="text" 
                                           readonly="1" 
                                           nolabel="1"/>
                                </group>
                            </group>
                        </page>
                        
                        <!-- TAB 2: DESTINATARIOS -->
                        <page string="üì± Destinatarios" name="recipients">
                            <group>
                                <group string="Tipo de Destinatario">
                                    <field name="recipient_type" widget="radio"/>
                                </group>
                            </group>
                            
                            <group string="Configuraci√≥n de Destinatarios">
                                <!-- Campo directo -->
                                <group invisible="recipient_type != 'field'">
                                    <field name="recipient_field_id" 
                                           domain="[('model_id', '=', model_id), ('ttype', '=', 'char')]"
                                           options="{'no_create': True}"/>
                                    <div class="alert alert-info" role="alert">
                                        <p>Selecciona un campo <code>Char</code> del modelo que contenga el n√∫mero de tel√©fono.</p>
                                        <p><strong>Ejemplos:</strong> mobile, phone, celular, telefono_contacto</p>
                                    </div>
                                </group>
                                
                                <!-- Campo relacionado -->
                                <group invisible="recipient_type != 'related'">
                                    <field name="recipient_related_path" 
                                           placeholder="partner_id.mobile"/>
                                    <div class="alert alert-info" role="alert">
                                        <p>Especifica la ruta al campo usando notaci√≥n punto.</p>
                                        <p><strong>Ejemplos:</strong></p>
                                        <ul>
                                            <li><code>partner_id.mobile</code></li>
                                            <li><code>cliente_id.phone</code></li>
                                            <li><code>user_id.partner_id.mobile</code></li>
                                        </ul>
                                    </div>
                                </group>
                                
                                <!-- N√∫mero fijo -->
                                <group invisible="recipient_type != 'fixed'">
                                    <field name="recipient_fixed_number" 
                                           placeholder="51987654321"/>
                                    <div class="alert alert-warning" role="alert">
                                        <p>‚ö†Ô∏è El mensaje se enviar√° SIEMPRE a este n√∫mero.</p>
                                        <p>Formato: <code>51987654321</code> (c√≥digo pa√≠s + n√∫mero)</p>
                                    </div>
                                </group>
                                
                                <!-- C√≥digo Python -->
                                <group invisible="recipient_type != 'python'" colspan="2">
                                    <field name="recipient_python_code" 
                                           widget="ace" 
                                           options="{'mode': 'python'}"
                                           placeholder="# Variable disponible: record&#10;# Debe asignar result = [lista de n√∫meros]&#10;&#10;result = []&#10;if record.partner_id.mobile:&#10;    result.append(record.partner_id.mobile)&#10;if record.tecnico_id.partner_id.mobile:&#10;    result.append(record.tecnico_id.partner_id.mobile)"
                                           nolabel="1"/>
                                    <div class="alert alert-info" role="alert">
                                        <p><strong>Instrucciones:</strong></p>
                                        <ul>
                                            <li>Variable disponible: <code>record</code> (el registro actual)</li>
                                            <li>Tambi√©n disponible: <code>env</code> (entorno de Odoo)</li>
                                            <li>Debe asignar <code>result = [lista_de_numeros]</code></li>
                                            <li>Ejemplo: <code>result = [record.mobile, record.partner_id.phone]</code></li>
                                        </ul>
                                    </div>
                                </group>
                                
                                <!-- M√∫ltiples destinatarios -->
                                <group invisible="recipient_type != 'multiple'" colspan="2">
                                    <field name="recipient_ids" nolabel="1">
                                        <list editable="bottom">
                                            <field name="sequence" widget="handle"/>
                                            <field name="name"/>
                                            <field name="recipient_type"/>
                                            <field name="recipient_field_id" 
                                                   column_invisible="parent.recipient_type != 'field'"
                                                   optional="show"/>
                                            <field name="recipient_related_path" 
                                                   column_invisible="parent.recipient_type != 'related'"
                                                   optional="show"/>
                                            <field name="recipient_fixed_number" 
                                                   column_invisible="parent.recipient_type != 'fixed'"
                                                   optional="show"/>
                                            <field name="is_backup"/>
                                            <field name="active" widget="boolean_toggle"/>
                                            <field name="model_id" column_invisible="1"/>
                                        </list>
                                    </field>
                                    <div class="alert alert-info" role="alert">
                                        <p><strong>üí° M√∫ltiples Destinatarios:</strong></p>
                                        <ul>
                                            <li>Los destinatarios se procesan en orden de secuencia</li>
                                            <li>Si un destinatario tiene n√∫mero v√°lido, se env√≠a y se detiene (a menos que sea "respaldo")</li>
                                            <li>Los marcados como "Respaldo" solo se usan si los anteriores fallaron</li>
                                        </ul>
                                    </div>
                                </group>
                            </group>
                            
                            <group>
                                <group string="Opciones">
                                    <field name="verify_number_before_send"/>
                                </group>
                            </group>
                        </page>
                        
                        <!-- TAB 3: TRIGGER -->
                        <page string="‚ö° Cu√°ndo Enviar" name="trigger">
                            <group>
                                <group string="Tipo de Trigger">
                                    <field name="trigger_type" widget="radio"/>
                                </group>
                            </group>
                            
                            <group string="Configuraci√≥n del Trigger">
                                <!-- Al modificar -->
                                <group invisible="trigger_type != 'write'" colspan="2">
                                    <field name="trigger_field_ids" 
                                           widget="many2many_tags"
                                           domain="[('model_id', '=', model_id)]"
                                           placeholder="Selecciona los campos que disparan la notificaci√≥n..."/>
                                    <div class="alert alert-info" role="alert">
                                        <p>Solo se enviar√° la notificaci√≥n si se modifican los campos seleccionados.</p>
                                        <p>Si no seleccionas ning√∫n campo, se enviar√° en cualquier modificaci√≥n.</p>
                                    </div>
                                </group>
                                
                                <!-- Cambio de estado -->
                                <group invisible="trigger_type != 'state_change'">
                                    <field name="trigger_state_field_id" 
                                           domain="[('model_id', '=', model_id), ('ttype', '=', 'selection')]"
                                           options="{'no_create': True}"/>
                                    <field name="trigger_state_from" 
                                           placeholder="Estado origen (vac√≠o = cualquiera)"/>
                                    <field name="trigger_state_to" 
                                           placeholder="Estado destino (requerido)"/>
                                </group>
                                
                                <group invisible="trigger_type != 'state_change'">
                                    <div class="alert alert-info" role="alert">
                                        <p><strong>üí° Cambio de Estado:</strong></p>
                                        <ul>
                                            <li><strong>Campo de Estado:</strong> Campo Selection que representa estados</li>
                                            <li><strong>Desde:</strong> Estado origen (opcional, vac√≠o = cualquier estado)</li>
                                            <li><strong>Hacia:</strong> Estado destino que dispara la notificaci√≥n</li>
                                        </ul>
                                        <p><strong>Ejemplo:</strong> De "borrador" ‚Üí A "confirmado"</p>
                                    </div>
                                </group>
                            </group>
                        </page>
                        
                        <!-- TAB 4: CONDICIONES -->
                        <page string="üéØ Condiciones" name="conditions">
                            <group>
                                <group string="Tipo de Condici√≥n">
                                    <field name="condition_type" widget="radio"/>
                                </group>
                            </group>
                            
                            <group string="Configuraci√≥n de Condiciones">
                                <!-- Domain -->
                                <group invisible="condition_type != 'domain'" colspan="2">
                                    <field name="condition_domain" 
                                           widget="ace" 
                                           options="{'mode': 'python'}"
                                           placeholder="[('campo', 'operador', 'valor')]"
                                           nolabel="1"/>
                                    <div class="alert alert-info" role="alert">
                                        <p><strong>Ejemplos de Domain:</strong></p>
                                        <ul>
                                            <li>Prioridad alta o cr√≠tica: <code>[('prioridad', 'in', ['2', '3'])]</code></li>
                                            <li>Cliente espec√≠fico: <code>[('partner_id.name', '=', 'Mi Cliente')]</code></li>
                                            <li>Monto mayor a 1000: <code>[('amount_total', '>', 1000)]</code></li>
                                            <li>M√∫ltiples condiciones: <code>[('estado', '!=', 'cancelado'), ('activo', '=', True)]</code></li>
                                        </ul>
                                    </div>
                                </group>
                                
                                <!-- Python -->
                                <group invisible="condition_type != 'python'" colspan="2">
                                    <field name="condition_python_code" 
                                           widget="ace" 
                                           options="{'mode': 'python'}"
                                           placeholder="# Variable disponible: record&#10;# Debe asignar result = True o False&#10;&#10;result = record.prioridad in ['2', '3'] and record.cliente_id"
                                           nolabel="1"/>
                                    <div class="alert alert-info" role="alert">
                                        <p><strong>Instrucciones:</strong></p>
                                        <ul>
                                            <li>Variable disponible: <code>record</code></li>
                                            <li>Debe asignar <code>result = True</code> o <code>result = False</code></li>
                                            <li>Si <code>result = True</code>, se env√≠a la notificaci√≥n</li>
                                            <li>Ejemplo: <code>result = record.amount_total > 1000 and record.state == 'sale'</code></li>
                                        </ul>
                                    </div>
                                </group>
                            </group>
                        </page>
                        
                        <!-- TAB 5: ADJUNTOS -->
                        <page string="üìé Adjuntos" name="attachments">
                            <group>
                                <group string="Configuraci√≥n">
                                    <field name="send_attachment"/>
                                </group>
                            </group>
                            
                            <group invisible="not send_attachment">
                                <group string="Archivo a Enviar">
                                    <field name="attachment_field_id" 
                                           domain="[('model_id', '=', model_id), ('ttype', '=', 'binary')]"
                                           options="{'no_create': True}"/>
                                    <field name="attachment_type"/>
                                    <field name="attachment_caption" 
                                           placeholder="Pie de foto o documento (puede usar variables)"/>
                                </group>
                                
                                <group>
                                    <div class="alert alert-info" role="alert">
                                        <p><strong>üí° Adjuntos:</strong></p>
                                        <ul>
                                            <li><strong>Campo:</strong> Selecciona un campo Binary del modelo</li>
                                            <li><strong>Tipo:</strong> Imagen, Documento, Video o Audio</li>
                                            <li><strong>Caption:</strong> Texto que acompa√±a al archivo (opcional)</li>
                                        </ul>
                                        <p>El caption puede usar variables como: <code>{"{name}"}</code>, <code>{"{partner_id.name}"}</code></p>
                                    </div>
                                </group>
                            </group>
                        </page>
                        
                        <!-- TAB 6: INFORMACI√ìN -->
                        <page string="‚ÑπÔ∏è Informaci√≥n" name="info">
                            <group>
                                <div class="alert alert-success" role="alert">
                                    <h4>‚úÖ C√≥mo Funciona esta Plantilla</h4>
                                    <ol>
                                        <li><strong>Modelo:</strong> Se aplica al modelo <field name="model_name" readonly="1" nolabel="1"/></li>
                                        <li><strong>Trigger:</strong> <field name="trigger_type" readonly="1" nolabel="1"/></li>
                                        <li><strong>Auto-aplicar:</strong> <field name="auto_apply" readonly="1" widget="boolean" nolabel="1"/></li>
                                    </ol>
                                </div>
                                
                                <div class="alert alert-info" role="alert">
                                    <h5>üîß Uso Manual</h5>
                                    <p>Para usar esta plantilla manualmente desde c√≥digo:</p>
                                    <pre>record.send_whatsapp_notification('<field name="code" readonly="1" nolabel="1"/>')</pre>
                                    
                                    <h5>üìä Estad√≠sticas</h5>
                                    <ul>
                                        <li>Total enviadas: <strong><field name="notification_count" readonly="1" nolabel="1"/></strong></li>
                                        <li>√öltima notificaci√≥n: <field name="last_notification_date" readonly="1" nolabel="1"/></li>
                                    </ul>
                                </div>
                            </group>
                        </page>
                    </notebook>
                </sheet>
                <chatter/>
            </form>
        </field>
    </record>

    <!-- ========================================= -->
    <!-- VISTA LISTA - PLANTILLA -->
    <!-- ========================================= -->
    <record id="view_whatsapp_template_list" model="ir.ui.view">
        <field name="name">whatsapp.template.list</field>
        <field name="model">whatsapp.template</field>
        <field name="arch" type="xml">
            <list string="Plantillas WhatsApp" default_order="sequence, model_id, name">
                <field name="sequence" widget="handle"/>
                <field name="name"/>
                <field name="code"/>
                <field name="model_id"/>
                <field name="trigger_type"/>
                <field name="auto_apply" widget="boolean_toggle"/>
                <field name="notification_count" optional="show"/>
                <field name="last_notification_date" optional="hide"/>
                <field name="active" widget="boolean_toggle"/>
            </list>
        </field>
    </record>

    <!-- ========================================= -->
    <!-- VISTA KANBAN - PLANTILLA -->
    <!-- ========================================= -->
    <record id="view_whatsapp_template_kanban" model="ir.ui.view">
        <field name="name">whatsapp.template.kanban</field>
        <field name="model">whatsapp.template</field>
        <field name="arch" type="xml">
            <kanban string="Plantillas WhatsApp" default_order="sequence, model_id, name">
                <field name="id"/>
                <field name="name"/>
                <field name="code"/>
                <field name="model_id"/>
                <field name="model_name"/>
                <field name="trigger_type"/>
                <field name="notification_count"/>
                <field name="active"/>
                <templates>
                    <t t-name="card">
                        <div class="oe_kanban_card oe_kanban_global_click">
                            <div class="o_kanban_card_header">
                                <div class="o_kanban_card_header_title">
                                    <div class="o_primary"><strong><field name="name"/></strong></div>
                                    <div class="text-muted"><small><field name="code"/></small></div>
                                </div>
                            </div>
                            <div class="o_kanban_card_content">
                                <div class="row">
                                    <div class="col-12">
                                        <span class="badge text-bg-primary"><field name="model_id"/></span>
                                    </div>
                                </div>
                                <div class="row mt-2">
                                    <div class="col-6">
                                        <i class="fa fa-bolt"/> <field name="trigger_type"/>
                                    </div>
                                    <div class="col-6">
                                        <i class="fa fa-paper-plane"/> <field name="notification_count"/> enviadas
                                    </div>
                                </div>
                            </div>
                            <div class="o_kanban_card_footer">
                                <div class="row">
                                    <div class="col-6">
                                        <field name="active" widget="boolean_toggle"/>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </t>
                </templates>
            </kanban>
        </field>
    </record>
    <!-- ========================================= -->
    <!-- VISTA B√öSQUEDA - PLANTILLA -->
    <!-- ========================================= -->
    <record id="view_whatsapp_template_search" model="ir.ui.view">
        <field name="name">whatsapp.template.search</field>
        <field name="model">whatsapp.template</field>
        <field name="arch" type="xml">
            <search string="Buscar Plantillas">
                <!-- Campos de b√∫squeda -->
                <field name="name"/>
                <field name="code"/>
                <field name="model_id"/>
                <field name="message_template"/>
                <field name="description"/>
                
                <!-- Filtros predefinidos -->
                <filter name="active" string="Activas" 
                        domain="[('active', '=', True)]"/>
                <filter name="inactive" string="Inactivas" 
                        domain="[('active', '=', False)]"/>
                
                <separator/>
                <filter name="auto_apply" string="Auto-aplicar" 
                        domain="[('auto_apply', '=', True)]"/>
                <filter name="manual" string="Manuales" 
                        domain="[('trigger_type', '=', 'manual')]"/>
                <filter name="auto_trigger" string="Trigger Autom√°tico" 
                        domain="[('trigger_type', '!=', 'manual')]"/>
                
                <separator/>
                <filter name="with_attachment" string="Con Adjuntos" 
                        domain="[('send_attachment', '=', True)]"/>
                <filter name="verify_number" string="Verificar N√∫mero" 
                        domain="[('verify_number_before_send', '=', True)]"/>
                
                <!-- Agrupar por -->
                <group expand="0" string="Agrupar Por">
                    <filter name="group_by_model" string="Modelo" 
                            context="{'group_by': 'model_id'}"/>
                    <filter name="group_by_trigger" string="Tipo de Trigger" 
                            context="{'group_by': 'trigger_type'}"/>
                    <filter name="group_by_recipient_type" string="Tipo de Destinatario" 
                            context="{'group_by': 'recipient_type'}"/>
                </group>
            </search>
        </field>
    </record>
</odoo>