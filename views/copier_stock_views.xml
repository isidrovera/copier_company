<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <!-- Vista Formulario para Checklist Items -->
    <record id="view_copier_checklist_item_form" model="ir.ui.view">
        <field name="name">copier.checklist.item.form</field>
        <field name="model">copier.checklist.item</field>
        <field name="arch" type="xml">
            <form>
                <sheet>
                    <group>
                        <field name="name"/>
                        <field name="sequence"/>
                        <field name="item_type"/>
                        <field name="active"/>
                    </group>
                </sheet>
            </form>
        </field>
    </record>

    <!-- Vista Lista para Checklist Items -->
    <record id="view_copier_checklist_item_list" model="ir.ui.view">
        <field name="name">copier.checklist.item.list</field>
        <field name="model">copier.checklist.item</field>
        <field name="arch" type="xml">
            <list>
                <field name="sequence" widget="handle"/>
                <field name="name"/>
                <field name="item_type"/>
            </list>
        </field>
    </record>



    <!-- Vista Formulario para Stock de Copiadoras -->
    <record id="view_copier_stock_form" model="ir.ui.view">
        <field name="name">copier.stock.form</field>
        <field name="model">copier.stock</field>
        <field name="arch" type="xml">
            <form>
                <header>
                    <!-- Botones para el flujo de estados -->
                    <button name="action_move_to_unloading" string="Mover a Descarga" type="object" 
                            class="oe_highlight" invisible="state != 'importing'"/>
                    <button name="action_move_to_available" string="Marcar Disponible" type="object" 
                            class="oe_highlight" invisible="state != 'unloading'"/>
                    <button name="action_reserve" string="Reservar" type="object" 
                            class="oe_highlight" invisible="state != 'available'"/>
                    <button name="action_pending_payment" string="Pendiente de Pago" type="object" 
                            class="oe_highlight" invisible="state != 'reserved'"/>
                    <button name="action_confirm_sale" string="Confirmar Venta" type="object" 
                            class="oe_highlight" invisible="state not in ('pending_payment', 'reserved')"/>
                    <button name="action_cancel_reservation" string="Cancelar Reserva" type="object"
                            invisible="state not in ('reserved', 'pending_payment')"/>
                    
                    <!-- Nuevos botones para órdenes de venta -->
                    <button name="action_create_sale_order" string="Crear Orden de Venta" type="object" 
                            class="btn-primary" invisible="state != 'available'"/>
                    <button name="action_add_to_existing_order" string="Agregar a Orden" type="object" 
                            class="btn-secondary" invisible="state != 'available'"/>
                    
                    <field name="state" widget="statusbar" options="{'clickable': '1'}"/>
                </header>
                <sheet>
                    <div class="oe_button_box" name="button_box">
                        <button name="toggle_active" type="object" class="oe_stat_button" icon="fa-archive">
                            <field name="active" widget="boolean_button" options="{'terminology':'archive'}"/>
                        </button>
                        <!-- Botón para ver orden si existe -->
                        <button name="action_view_sale_order" type="object" class="oe_stat_button" icon="fa-shopping-cart"
                                invisible="not sale_order_id">
                            <div class="o_field_widget o_stat_info">
                                <span class="o_stat_text">Orden de</span>
                                <span class="o_stat_text">Venta</span>
                            </div>
                        </button>
                    </div>
                    <div class="oe_title">
                        <h1><field name="name" readonly="1"/></h1>
                    </div>
                    
                    <!-- Alerta si está en una orden -->
                    <div class="alert alert-info" role="alert" invisible="not sale_order_id">
                        <i class="fa fa-info-circle me-2"></i>
                        <strong>Esta máquina está en la orden:</strong> 
                        <field name="sale_order_id" readonly="1" nolabel="1"/>
                    </div>
                    
                    <group>
                        <group>
                            <field name="customer_id"/> 
                            <field name="modelo_id"/>
                            <field name="marca_id"/>
                            <field name="serie"/>
                            <field name="tipo"/>
                        </group>
                        <group>
                            <field name="contometro"/>                            
                            <field name="reparacion"/>
                            <field name="sale_price"/>
                            <field name="checklist_status" widget="badge" decoration-success="checklist_status == 'completed'" decoration-warning="checklist_status == 'in_progress'" decoration-danger="checklist_status == 'pending'"/>
                        </group>
                    </group>
                    <notebook>
                        <page string="Datos de Importación">
                            <group>
                                <group>
                                    <field name="import_date"/>
                                    <field name="unloading_date"/>
                                </group>
                                <group>
                                    <field name="import_reference"/>
                                    <field name="shipping_company"/>
                                </group>
                            </group>
                        </page>
                        <page string="Checklist">
                            <group>
                                <field name="checklist_ids">
                                    <list editable="bottom" decoration-danger="state == 'poor'" decoration-warning="state == 'regular'" decoration-success="state == 'good'" decoration-info="state == 'not_reviewed'">
                                        <field name="sequence" widget="handle"/>
                                        <field name="item_id"/>
                                        <field name="name"/>
                                        <field name="state"/>
                                        <field name="notes"/>
                                        <field name="requires_action" invisible="1"/>
                                    </list>
                                </field>
                            </group>
                        </page>
                        <page string="Accesorios">
                            <field name="accesorios_ids" widget="many2many_tags"/>
                        </page>
                        <page string="Imágenes">
                            <group>
                                <field name="image" widget="image" class="oe_avatar"/>
                            </group>
                            <field name="image_ids">
                                <kanban>
                                    <field name="id"/>
                                    <field name="name"/>
                                    <field name="image"/>
                                    <templates>
                                        <t t-name="card">
                                            <div class="oe_kanban_global_click">
                                                <div class="o_kanban_image">
                                                    <img t-att-src="kanban_image('copier.stock.image','image',record.id.raw_value)" alt="Imagen"/>
                                                </div>
                                                <div class="oe_kanban_details">
                                                    <strong class="o_kanban_record_title">
                                                        <field name="name"/>
                                                    </strong>
                                                </div>
                                            </div>
                                        </t>
                                    </templates>
                                </kanban>
                                <form>
                                    <group>
                                        <field name="name"/>
                                        <field name="image" widget="image"/>
                                    </group>
                                </form>
                            </field>
                        </page>
                        <page string="Datos de Venta">
                            <group>
                                <group>
                                    <field name="reserved_by"/>
                                    <field name="reserved_date" readonly="1"/>
                                    <field name="sale_order_id" readonly="1" invisible="not sale_order_id"/>
                                </group>
                                <group>
                                    <field name="sold_date" readonly="1"/>
                                    <field name="payment_verified"/>
                                    <field name="sale_order_line_id" readonly="1" invisible="1"/>
                                </group>
                            </group>
                            <group string="Comprobante de Pago">
                                <field name="payment_proof" filename="payment_proof_filename" widget="binary"/>
                                <field name="payment_proof_filename" invisible="1"/>
                            </group>
                            <field name="notes" placeholder="Notas adicionales..."/>
                        </page>
                    </notebook>
                </sheet>
                <chatter/>
            </form>
        </field>
    </record>



    <!-- Vista del asistente para crear orden -->
    <record id="view_copier_sale_order_wizard_form" model="ir.ui.view">
        <field name="name">copier.sale.order.wizard.form</field>
        <field name="model">copier.sale.order.wizard</field>
        <field name="arch" type="xml">
            <form>
                <sheet>
                    <group>
                        <group>
                            <field name="partner_id" placeholder="Seleccionar cliente..."/>
                            <field name="single_machine" invisible="1"/>
                            <field name="reservation_days"/>
                        </group>
                        <group>
                            <field name="total_amount" readonly="1" widget="monetary"/>
                            <field name="notes" placeholder="Notas adicionales..."/>
                        </group>
                    </group>
                    
                    <notebook>
                        <page string="Máquinas Seleccionadas" name="machines">
                            <field name="machine_ids" nolabel="1" readonly="1">
                                <list>
                                    <field name="name"/>
                                    <field name="marca_id"/>
                                    <field name="modelo_id"/>
                                    <field name="serie"/>
                                    <field name="tipo"/>
                                    <field name="sale_price" widget="monetary"/>
                                    <field name="state"/>
                                </list>
                            </field>
                        </page>
                    </notebook>
                </sheet>
                
                <footer>
                    <button name="action_create_order" 
                            type="object" 
                            string="Crear Orden" 
                            class="btn-primary"/>
                    <button string="Cancelar" 
                            class="btn-secondary" 
                            special="cancel"/>
                </footer>
            </form>
        </field>
    </record>

    <!-- Vista del asistente para agregar a orden existente -->
    <record id="view_copier_add_to_order_wizard_form" model="ir.ui.view">
        <field name="name">copier.add.to.order.wizard.form</field>
        <field name="model">copier.add.to.order.wizard</field>
        <field name="arch" type="xml">
            <form>
                <sheet>
                    <group>
                        <field name="machine_id" readonly="1"/>
                        <field name="sale_order_id" 
                               placeholder="Seleccionar orden existente..."
                               domain="[('state', 'in', ['draft', 'sent'])]"/>
                    </group>
                </sheet>
                
                <footer>
                    <button name="action_add_to_order" 
                            type="object" 
                            string="Agregar a Orden" 
                            class="btn-primary"/>
                    <button string="Cancelar" 
                            class="btn-secondary" 
                            special="cancel"/>
                </footer>
            </form>
        </field>
    </record>

    <!-- Acción para crear órdenes múltiples -->
    <record id="action_create_multiple_sale_order" model="ir.actions.server">
        <field name="name">Crear Orden de Venta Múltiple</field>
        <field name="model_id" ref="model_copier_stock"/>
        <field name="binding_model_id" ref="model_copier_stock"/>
        <field name="binding_view_types">list</field>
        <field name="state">code</field>
        <field name="code">
action = records.action_create_multiple_sale_order()
        </field>
    </record>

    <!-- Vista Lista para Stock de Copiadoras -->
    <record id="view_copier_stock_list" model="ir.ui.view">
        <field name="name">copier.stock.list</field>
        <field name="model">copier.stock</field>
        <field name="arch" type="xml">
            <list decoration-success="state=='available'" decoration-info="state=='reserved'" decoration-muted="state=='sold'">
                <field name="name"/>
                <field name="marca_id"/>
                <field name="modelo_id"/>
                <field name="serie"/>
                <field name="tipo"/>
                <field name="contometro"/>
                
                <field name="state"/>
                <field name="sale_price"/>
                <field name="reserved_by"/>
                <field name="reserved_date"/>
                <field name="sold_date"/>
            </list>
        </field>
    </record>

   

  <!-- Vista Kanban para Stock de Copiadoras (Odoo 17/18) -->
<record id="view_copier_stock_kanban" model="ir.ui.view">
  <field name="name">copier.stock.kanban</field>
  <field name="model">copier.stock</field>
  <field name="arch" type="xml">
    <kanban class="o_kanban_mobile" create="1" quick_create="0">
      <!-- Declarar campos usados en la card -->
      <field name="name"/>
      <field name="marca_id"/>
      <field name="modelo_id"/>
      <field name="serie"/>
      <field name="tipo"/>
      <field name="state"/>
      <field name="contometro"/>
      <field name="sale_price"/>
      <field name="image"/>
      <!-- Si tienes currency_id, descomenta la siguiente línea y usa widget monetary más abajo -->
      <!-- <field name="currency_id"/> -->

      <templates>
        <t t-name="card">
          <t t-set="estado" t-value="record.state.raw_value or ''"/>
          <t t-set="badge_class"
             t-value="('bg-success' if estado == 'available' else
                      'bg-warning' if estado == 'reserved' else
                      'bg-info'    if estado == 'pending_payment' else
                      'bg-secondary')"/>

          <div class="o_kanban_record o_kanban_global_click o_kanban_record_has_image_fill">
            <!-- Imagen lateral -->
            <div class="o_kanban_image_fill_left">
              <img t-att-src="kanban_image('copier.stock','image',record.id.raw_value)"
                   t-att-alt="record.name.value"
                   class="o_kanban_image_fill"/>
            </div>

            <!-- Detalles -->
            <div class="oe_kanban_details">
              <!-- Header -->
              <div class="o_kanban_record_top d-flex justify-content-between align-items-start">
                <div class="o_kanban_record_headings">
                  <strong class="o_kanban_record_title">
                    <field name="name"/>
                  </strong>
                </div>
                <span class="badge rounded-pill" t-att-class="badge_class">
                  <field name="state"/>
                </span>
              </div>

              <!-- Cuerpo -->
              <div class="o_kanban_record_body">
                <div class="mb-1"><field name="modelo_id"/></div>
                <div>Serie: <field name="serie"/></div>
                <div>Tipo: <field name="tipo"/></div>
                <div class="mt-1">
                  <i class="fa fa-print text-primary me-2"/> Contador: <field name="contometro"/>
                </div>

                <t t-if="record.sale_price.raw_value">
                  <div class="mt-2">
                    <!-- Si tienes currency_id, usa: <field name="sale_price" widget="monetary" options="{'currency_field':'currency_id'}"/> -->
                    <strong>Precio: </strong><field name="sale_price"/>
                  </div>
                </t>
              </div>
            </div>
          </div>
        </t>
      </templates>
    </kanban>
  </field>
</record>


 


</odoo>
