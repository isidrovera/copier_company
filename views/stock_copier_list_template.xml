<odoo>
  <!-- Página de listado de copiadoras con OWL mounting point -->
  <template id="copier_list" name="Listado de Fotocopiadoras">
      <t t-call="website.layout">
          <div class="copier-list-container" t-ref="container">
              <div class="container py-3">

                  <!-- Encabezado con contador de equipos -->
                  <div class="d-flex justify-content-between align-items-center mb-3">
                      <h2 class="mb-0">
                          <i class="fa fa-print text-primary me-2"></i>Stock de Fotocopiadoras
                          <span class="badge bg-secondary rounded-pill ms-2" t-esc="len(machines)"></span>
                      </h2>
                      <!-- Botones de vista - Iconos más grandes -->
                      <div class="btn-group btn-group-sm" role="group" aria-label="Vista">
                          <button id="btn-list-view" type="button" class="btn btn-outline-primary active">
                              <i class="fa fa-list fa-lg"></i><span class="d-none d-sm-inline ms-1">Lista</span>
                          </button>
                          <button id="btn-kanban-view" type="button" class="btn btn-outline-primary">
                              <i class="fa fa-th-large fa-lg"></i><span class="d-none d-sm-inline ms-1">Tarjetas</span>
                          </button>
                      </div>
                  </div>

                  <!-- Filtros compactos -->
                  <div class="card mb-3 shadow-sm border-0">
                      <div class="card-body p-3">
                        <form id="filter-form" action="/stock-maquinas" method="get" class="row g-2">

                              <div class="col-md-3 col-sm-6">
                                  <div class="input-group input-group-sm">
                                      <span class="input-group-text"><i class="fa fa-search"></i></span>
                                      <input type="text" name="search" class="form-control" placeholder="Buscar..." t-att-value="search or ''"/>
                                  </div>
                              </div>
                              <div class="col-md-3 col-sm-6">
                                  <div class="input-group input-group-sm">
                                      <span class="input-group-text"><i class="fa fa-tag"></i></span>
                                      <select name="marca" class="form-select">
                                          <option value="">Todas las marcas</option>
                                          <t t-foreach="marcas" t-as="marca">
                                              <option t-att-value="marca.id" t-att-selected="marca.id == (selected_marca or 0)"><t t-esc="marca.name"/></option>
                                          </t>
                                      </select>
                                  </div>
                              </div>
                              <div class="col-md-3 col-sm-6">
                                  <div class="input-group input-group-sm">
                                      <span class="input-group-text"><i class="fa fa-cog"></i></span>
                                      <select name="tipo" class="form-select">
                                          <option value="">Todos los tipos</option>
                                          <option value="monocroma" t-att-selected="selected_tipo == 'monocroma'">Monocroma</option>
                                          <option value="color" t-att-selected="selected_tipo == 'color'">Color</option>
                                      </select>
                                  </div>
                              </div>
                              <div class="col-md-3 col-sm-6">
                                  <div class="input-group input-group-sm">
                                      <span class="input-group-text"><i class="fa fa-filter"></i></span>
                                      <select name="estado" class="form-select">
                                          <option value="">Todos los estados</option>
                                          <option value="available" t-att-selected="selected_estado == 'available'">Disponible</option>
                                          <option value="reserved" t-att-selected="selected_estado == 'reserved'">Reservada</option>
                                          <option value="pending_payment" t-att-selected="selected_estado == 'pending_payment'">Pago Pendiente</option>
                                          <option value="sold" t-att-selected="selected_estado == 'sold'">Vendido</option>
                                          <option value="importing" t-att-selected="selected_estado == 'importing'">En Importación</option>
                                          <option value="unloading" t-att-selected="selected_estado == 'unloading'">En Descarga</option>
                                      </select>
                                  </div>
                              </div>
                              <!-- Checkbox para mostrar solo disponibles -->
                              <div class="col-12">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox"
                                           id="show-available-only"
                                           name="available_only"
                                           value="on"
                                           t-att-checked="available_only != 'off'"/> <!-- ✅ activado por defecto -->
                                    <label class="form-check-label" for="show-available-only">
                                        Mostrar solo máquinas disponibles
                                    </label>
                                </div>
                            </div>
                            
                              <div class="col-12 d-flex justify-content-end">
                                  
                                  <a href="/stock-maquinas" class="btn btn-sm btn-primary me-2"><i class="fa fa-times me-1"></i>Limpiar</a>
                              </div>
                          </form>
                      </div>
                  </div>

                  <!-- Vista Lista -->
                  <div id="list-view" class="table-responsive">
                      <table class="table table-sm table-hover">
                          <thead>
                              <tr class="table-light">
                                  <th>Imagen</th>
                                  <th>Referencia</th>
                                  <th>Marca / Modelo</th>
                                  <th class="d-none d-md-table-cell">Tipo</th>
                                  <th class="d-none d-md-table-cell">Contómetro</th>
                                  <th>Precio</th>
                                  <th>Estado</th>
                                  <th>Acción</th>
                              </tr>
                          </thead>
                          <tbody>
                            <t t-if="not machines">
                                <tr>
                                    <td colspan="8" class="text-center py-4">
                                        <div class="alert alert-info mb-0">
                                            <i class="fa fa-info-circle me-2"></i>No hay máquinas disponibles.</div>
                                    </td>
                                </tr>
                            </t>
                            <t t-foreach="machines" t-as="machine">
                                <tr t-att-class="machine.state == 'sold' and 'table-secondary' or ''">
                                    <td class="align-middle">
                                        <div class="avatar avatar-md">
                                            <t t-if="machine.image">
                                                <img class="img-thumbnail"
                                                     style="max-width:80px; max-height:60px; object-fit:contain;"
                                                     t-att-src="'data:image/png;base64,%s' % (machine.image.decode('utf-8'))"
                                                     alt="Imagen principal"/>
                                            </t>
                                            <t t-else="">
                                                <img class="rounded p-1" style="width:48px;height:48px;object-fit:contain;"
                                                     t-att-src="'/web/image?model=machine.model&amp;id=%s&amp;field=imagen' % machine.modelo_id.id"
                                                     alt="Modelo"/>
                                            </t>
                                        </div>
                                    </td>
                                    <td class="align-middle"><t t-esc="machine.name"/></td>
                                    <td class="align-middle"><t t-esc="machine.marca_id.name"/> / <t t-esc="machine.modelo_id.name"/></td>
                                    <td class="d-none d-md-table-cell align-middle">
                                        <span t-if="machine.tipo=='monocroma'" class="badge bg-secondary">Mono</span>
                                        <span t-else="" class="badge bg-info">Color</span>
                                    </td>
                                    <td class="d-none d-md-table-cell align-middle">
                                        <small><i class="fa fa-print"/> <t t-esc="machine.contometro"/></small>
                                    </td>
                                    <td class="align-middle"><span class="badge bg-success">$<t t-esc="machine.sale_price"/> </span></td>
                                    <td class="align-middle">
                                        <t t-call="copier_company.machine_status_badge"/>
                                        <t t-if="machine.reserved_by.id == user.partner_id.id">
                                            <br/>
                                            <span class="badge bg-primary mt-1">Tu máquina</span>
                                        </t>
                                    </td>
                                    <td class="align-middle">
                                        <a t-att-href="'/stock-maquinas/%s' % machine.id"
                                           class="btn btn-dark btn-sm rounded-pill shadow-sm px-3 py-2">
                                            <i class="fa fa-eye fa-lg"></i>
                                            <span class="ms-2">Detalle</span>
                                        </a>
                                    </td>
                                </tr>
                            </t>
                        </tbody>
                        
                        
                      </table>
                  </div>

                  <!-- Vista Kanban -->
                
                  <!-- Vista Kanban -->
                  <div id="kanban-view" class="row row-cols-1 row-cols-sm-2 row-cols-md-3 row-cols-xl-4 g-3" style="display:none">
                    <t t-if="machines and len(machines) &gt; 0">
                      <t t-foreach="machines" t-as="machine">
                        <div class="col">
                          <div t-att-class="'card h-100 shadow-sm copier-card ' + (machine.state == 'sold' and 'bg-light' or '')">
                            <div class="position-relative">
                              <t t-if="machine.image">
                                <img class="card-img-top p-3"
                                    style="height: 200px; object-fit: contain;"
                                    t-att-src="'data:image/png;base64,%s' % (machine.image.decode('utf-8'))"
                                    alt="Imagen principal"/>
                              </t>
                              <t t-else="">
                                <img class="card-img-top p-3"
                                    style="height: 180px; object-fit: contain;"
                                    src="/copier_company/static/src/img/placeholder-image.png"
                                    alt="Sin imagen disponible"/>
                              </t>
                              <div class="position-absolute top-0 end-0 p-2">
                                <t t-if="machine.tipo=='monocroma'" class="badge bg-secondary">Mono</t>
                                <t t-else="" class="badge bg-info">Color</t>
                              </div>
                              <div class="position-absolute top-0 start-0 p-2">
                                <t t-call="copier_company.machine_status_badge"/>
                              </div>
                            </div>
                            <div class="card-body d-flex flex-column p-3">
                              <h6 class="card-title text-truncate mb-2"><t t-esc="machine.name"/></h6>
                              <p class="small mb-1"><strong>Marca/Modelo:</strong> <t t-esc="machine.marca_id.name"/> / <t t-esc="machine.modelo_id.name"/></p>
                              <p class="small mb-1"><strong>Contómetro:</strong> <t t-esc="machine.contometro"/></p>
                              <p class="mb-3"><strong>Precio:</strong> <span class="badge bg-success"><t t-esc="machine.sale_price"/> $</span></p>
                              <div class="mt-auto d-flex gap-2">
                                <a t-att-href="'/stock-maquinas/%s' % machine.id" class="btn btn-sm btn-dark flex-grow-1">
                                  <i class="fa fa-eye fa-lg me-1"></i>Detalles
                                </a>
                                <t t-if="machine.state=='available'">
                                  <button type="button" class="btn btn-sm btn-primary flex-grow-1 reserve-btn" t-att-data-machine-id="machine.id">
                                    <i class="fa fa-calendar-check fa-lg me-1"></i>Reservar
                                  </button>
                                </t>
                              </div>
                              <t t-if="machine.state=='sold' and machine.reserved_by.id==user.partner_id.id">
                                <div class="alert alert-success mt-2 p-2 text-center small">Adquirida por ti</div>
                              </t>
                            </div>
                          </div>
                        </div>
                      </t>
                    </t>
                    <t t-else="">
                      <div class="col-12">
                        <div class="alert alert-info text-center"><i class="fa fa-info-circle me-2"></i>No hay máquinas.</div>
                      </div>
                    </t>
                  </div>


                  <!-- Modal de confirmación -->
                  <div class="modal fade" id="reserveModal" tabindex="-1" aria-labelledby="reserveModalLabel" aria-hidden="true">
                      <div class="modal-dialog modal-dialog-centered">
                          <div class="modal-content">
                              <div class="modal-header">
                                  <h5 class="modal-title" id="reserveModalLabel">Confirmar Reserva</h5>
                                  <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                              </div>
                              <div class="modal-body">
                                  ¿Seguro que deseas reservar esta máquina? Tienes 48h para concretar.
                              </div>
                              <div class="modal-footer">
                                  <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                                  <form id="reserveForm" method="post">
                                      <input type="hidden" name="csrf_token" t-att-value="request.csrf_token()"/>
                                      <button type="submit" class="btn btn-primary">Confirmar Reserva</button>
                                  </form>
                              </div>
                          </div>
                      </div>
                  </div>

              </div>
          </div>
          <!-- CSS personalizado -->
          <link rel="stylesheet" href="/copier_company/static/src/css/copier_list.css"/>
          <script type="text/javascript">
            document.addEventListener('DOMContentLoaded', function () {
                console.log('[DEBUG] script incrustado ejecutado');
          
                var container = document.querySelector('.copier-list-container');
                if (!container) { return; }
          
                var btnList = container.querySelector('#btn-list-view');
                var btnKanban = container.querySelector('#btn-kanban-view');
                var listView = container.querySelector('#list-view');
                var kanbanView = container.querySelector('#kanban-view');
          
                function toggleView(mode) {
                    if (mode === 'kanban') {
                        listView.style.display = 'none';
                        kanbanView.style.display = 'block';
                        btnList.classList.remove('active');
                        btnKanban.classList.add('active');
                    } else {
                        listView.style.display = 'block';
                        kanbanView.style.display = 'none';
                        btnList.classList.add('active');
                        btnKanban.classList.remove('active');
                    }
                    localStorage.setItem('copierViewPreference', mode);
                }
          
                if (btnList) {
                    btnList.addEventListener('click', function() {
                        toggleView('list');
                    });
                }
          
                if (btnKanban) {
                    btnKanban.addEventListener('click', function() {
                        toggleView('kanban');
                    });
                }
          
                toggleView(localStorage.getItem('copierViewPreference') || 'list');
          
                var reserveBtns = container.querySelectorAll('.reserve-btn');
                var reserveForm = container.querySelector('#reserveForm');
                var reserveModalEl = container.querySelector('#reserveModal');
          
                if (typeof bootstrap !== 'undefined' &amp;&amp; reserveModalEl) {
                    var reserveModal = new bootstrap.Modal(reserveModalEl);
                    reserveBtns.forEach(function (btn) {
                        btn.addEventListener('click', function () {
                            var id = btn.dataset.machineId;
                            reserveForm.action = '/stock-maquinas/' + id + '/reserve';
                            reserveModal.show();
                        });
                    });
                }
            });
          </script>
          <script>
            document.addEventListener('DOMContentLoaded', function () {
                const form = document.getElementById('filter-form');
                if (!form) return;
        
                // Escuchar cambios en todos los selects y checkbox del formulario
                const inputs = form.querySelectorAll('select, input[type="checkbox"], input[name="search"]');
        
                inputs.forEach(input =&gt; {
                    input.addEventListener('change', () =&gt; {
                        form.submit();
                    });
        
                    // Para input[type=text] esperar a que se escriba y presione Enter
                    if (input.name === 'search') {
                        input.addEventListener('keydown', function (event) {
                            if (event.key === 'Enter') {
                                event.preventDefault();
                                form.submit();
                            }
                        });
                    }
                });
            });
        </script>
        
          
      </t>
  </template>

  <!-- Badge de estado de máquina -->
  <template id="machine_status_badge" name="Machine Status Badge">
      <span t-if="machine.state=='available'" class="badge bg-success"><i class="fa fa-check-circle me-1"></i>Disponible</span>
      <span t-elif="machine.state=='reserved'" class="badge bg-warning text-dark"><i class="fa fa-clock me-1"></i>Reservada</span>
      <span t-elif="machine.state=='pending_payment'" class="badge bg-warning text-dark"><i class="fa fa-money-bill me-1"></i>Pago Pendiente</span>
      <span t-elif="machine.state=='sold'" class="badge bg-danger"><i class="fa fa-shopping-cart me-1"></i>Vendida</span>
      <span t-elif="machine.state=='importing'" class="badge bg-info text-dark"><i class="fa fa-ship me-1"></i>Importando</span>
      <span t-elif="machine.state=='unloading'" class="badge bg-info text-dark"><i class="fa fa-truck me-1"></i>Descargando</span>
      <span t-else="" class="badge bg-secondary"><i class="fa fa-question-circle me-1"></i><t t-esc="machine.state"/></span>
  </template>
</odoo>